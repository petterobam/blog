<!DOCTYPE html>

<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="zh">
<!--<![endif]-->

<head>
    <meta charset="utf-8">
<!--[if IE]><meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'><![endif]-->
<meta name="viewport" content="width=device-width,initial-scale=1">

<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>SpringBoot 学习笔记 | 欧阳Boy_Petter&#39;s Blog</title>
<meta name="generator" content="Jekyll v3.5.2" />
<meta property="og:title" content="SpringBoot 学习笔记" />
<meta name="author" content="欧阳Boy_Petter" />
<meta property="og:locale" content="zh" />
<meta name="description" content="环境支持" />
<meta property="og:description" content="环境支持" />
<meta property="og:site_name" content="欧阳Boy_Petter&#39;s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-07-22T00:00:00+00:00" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"欧阳Boy_Petter"},"description":"环境支持","@type":"BlogPosting","url":"/learner_posts/programming/SpringBoot/","headline":"SpringBoot 学习笔记","dateModified":"2018-07-22T00:00:00+00:00","datePublished":"2018-07-22T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"/learner_posts/programming/SpringBoot/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<meta name="keywords" content="" />





<link type="application/atom+xml" rel="alternate" href="/feed.xml" title="欧阳Boy_Petter's Blog" />
    <link href='/assets/stylesheets/blog.css' rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" href="/blog/learner/static/css/learn.css" type="text/css"/>
    <link rel="stylesheet" href="/assets/stylesheets/prism.css"/>
    <script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
<script>window.Modernizr || document.write('<script src="/assets/javascripts/modernizr-2.8.3.min.js"><\/script>')</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>
    window.jQuery || document.write('<script src="/assets/javascripts/jquery-3.2.1.min.js"><\/script>')
</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"></script>
<script>
    window.Pace || document.write('<script src="/assets/javascripts/pace.min.js"><\/script>')
</script>


</head>

<body>
    <!--[if IE]>
    <p class="site-notice">您正在使用一个过时的网页浏览器。请<a href="http://browsehappy.com/" target="_blank">升级您的浏览器</a>或<a href="http://www.google.com/chromeframe/?redirect=true" target="_blank">开启 Google Chrome Frame</a> 来提高用户体验。</p>
<![endif]-->
<noscript>
    <p class="site-notice">本网站需要 JavaScript。请查阅指南来<a href="http://www.enable-javascript.com/" target="_blank">给您的浏览器开启 JavaScript 功能</a>。</p>
</noscript>

    <div class="nav-wrapper overlay-wrapper">
    <div class="nav-form overlay-form">
        <span class="overlay-header menu">菜单</span>
        <a class="btn-close">关闭</a>
        <div class="results">
            <ul>
                <li><a href="/blog/">文章</a></li>
                <li><a href="/blog/categories/">分类</a></li>
                <li><a href="/blog/tags/">标签</a></li>

                <li><a href="/blog/reader/">读书</a></li>
                <li><a href="/blog/movie/">影音</a></li>
                <li><a href="/blog/book+movie/">书&影</a></li>

                <li><a href="/blog/learner/">笔记</a></li>
                <li><a href="/blog/life/">动态</a></li>
                <li><a href="/blog/letter/">信</a></li>
                <li><a href="/blog/song/">歌</a></li>
                <li><a href="/blog/story/">文</a></li>
                <li><a href="/blog/plan/">业</a></li>
                <li><a href="/blog/family/">家</a></li>
                <li><a href="/blog/other/">杂</a></li>
                <li><a href="/">关于</a></li>
            </ul>
        </div>
    </div>
</div>

<div class="search-wrapper overlay-wrapper">
    <div class="search-form overlay-form">
        <input type="text" class="overlay-header search-field" placeholder="搜索...">
        <a class="btn-close">关闭</a>
        <ul class="results"></ul>
    </div>
</div>


    <div id="page" class="hentry">
        <header class="the-header">
    <div class="unit-head">
        <div class="unit-inner unit-head-inner">
            <nav class="nav-global">
                <ul>
                    <li class="logo">
                        <button class="btn-menu" title="菜单"></button>
                        <a href="/blog/">欧阳Boy_Petter's Blog</a>
                        <!--[if !IE]> -->
                        <button class="btn-search" title="搜索"></button>
                        <!-- <![endif]-->
                    </li>
                    <li class="nav-link"><a label="article" title="文章" href="/blog/">文章</a></li>

                    <!-- <li class="nav-link"><a label="book" title="读书" href="/blog/reader/">读书</a></li> -->
                    <!-- <li class="nav-link"><a label="movie" title="影音" href="/blog/movie/">影音</a></li> -->
                    <li class="nav-link"><a label="book+movie" title="书&影" href="/blog/book+movie/">书&影</a></li>
                    
                    <li class="nav-link"><a label="learn" title="笔记" href="/blog/learner/">笔记</a></li>
                    <li class="nav-link"><a label="life" title="动态" href="/blog/life/">动态</a></li>
                    <li class="nav-link"><a label="letter" title="信" href="/blog/letter/">信</a></li>
                    <li class="nav-link"><a label="song" title="歌" href="/blog/song/">歌</a></li>
                    <li class="nav-link"><a label="story" title="文" href="/blog/story/">文</a></li>
                    <li class="nav-link"><a label="plan" title="业" href="/blog/plan/">业</a></li>
                    <li class="nav-link"><a label="family" title="家" href="/blog/family/">家</a></li>
                    <li class="nav-link"><a label="other" title="杂" href="/blog/other/">杂</a></li>
                    <!--[if !IE]> -->
                    <li class="nav-link"><a title="搜索" class="btn-search" href="#">搜索</a></li>
                    <!-- <![endif]-->
                </ul>
            </nav>
        </div>
    </div>
</header>


        <div class="body animated fadeInDown" role="main">
            <div class="unit-body">
                <div class="unit-inner unit-body-inner">
                    <div class="entry-content">
                        <header>
                            <h1 id="big-title">SpringBoot 学习笔记</h1>
                        </header>
                        <div class="main-content">
                            <!-- 新增导航目录 -->
                            
<link rel="stylesheet" href="/assets/stylesheets/nav.css" type="text/css"/>
<div class="nav-container">
    <nav>
        <div class="menubar expand button_active" id="mediaMenubar">
        目录<span class="small-title">（点击收起）</span>
        </div>
        <div id="java-nav-directory"></div>
        <div id="js-nav-directory"></div>
    </nav>
</div>
<script defer type="text/javascript" src="/assets/javascripts/plugin/nav.js"></script>

                            <div id="article-container" class="article-container" style=''>
                                <article id="article-content">
                                    <h2 id="heading-环境支持">环境支持</h2>

<blockquote>
  <p>JDK8+</p>
</blockquote>

<h2 id="heading-学习基础">学习基础</h2>

<blockquote>
  <p>Spring MVC</p>
</blockquote>

<blockquote>
  <p>Maven</p>
</blockquote>

<blockquote>
  <p>装软件</p>
</blockquote>

<h2 id="heading-部署springboot">部署SpringBoot</h2>

<h3 id="heading-springboot支持">SpringBoot支持</h3>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;parent&gt;</span>
	<span class="nt">&lt;groupld&gt;</span>org.springframework.boot<span class="nt">&lt;/groupld&gt;</span>
	<span class="nt">&lt;artifactld&gt;</span>spring-boot-starter-parent<span class="nt">&lt;/artifactld&gt;</span>
	<span class="nt">&lt;version&gt;</span>1.5.9.RELEASE<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/parent&gt;</span>
</code></pre>
</div>

<h3 id="heading-增加web支持">增加Web支持</h3>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupid&gt;</span>org.springframework.boot<span class="nt">&lt;/groupid&gt;</span>
	<span class="nt">&lt;artifactid&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactid&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre>
</div>

<h3 id="heading-热部署支持">热部署支持</h3>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupid&gt;</span>org.springframework.boot<span class="nt">&lt;/groupid&gt;</span>
	<span class="nt">&lt;artifactid&gt;</span>spring-boot-devtools<span class="nt">&lt;/artifactid&gt;</span>
	<span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre>
</div>

<h3 id="heading-restful支持">RESTFul支持</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>@RestController
</code></pre>
</div>

<h3 id="heading-服务器配置">服务器配置</h3>

<table>
  <thead>
    <tr>
      <th>属性</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>server.address</td>
      <td>服务器E 绑定地址，如果你的主机上有多个网卡，可以绑定一个IP 地址</td>
    </tr>
    <tr>
      <td>server.session.timeout</td>
      <td>会话过期时间，以秒为单位</td>
    </tr>
    <tr>
      <td>server.error.path</td>
      <td>服务器出错后的处理路径 /error</td>
    </tr>
    <tr>
      <td>server.servlet.contextpath</td>
      <td>Spring Boot 应用的上下文</td>
    </tr>
    <tr>
      <td>server.port</td>
      <td>Spring Boot应用监听端口</td>
    </tr>
  </tbody>
</table>

<h3 id="heading-配置启动信息">配置启动信息</h3>

<p>resources目录下新建一个 banner.txt ，启动时候会输出 banner.txt 里面的内容。</p>

<p>浏览器显示的 logo 小图标 ，可以在顶层布局页面里添加:</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"shortcut icon"</span> <span class="na">href=</span><span class="s">"图片地址"</span><span class="nt">/&gt;</span>
</code></pre>
</div>

<p>或在 resources/static 目录下添加 favicon.ico 图标文件，默认也会覆盖 spring boot 的默认图标</p>

<h2 id="heading-日志配置">日志配置</h2>

<p>application.properties 中加入以下代码：</p>
<div class="language-properties highlighter-rouge"><pre class="highlight"><code><span class="py">logging.level.root</span><span class="p">=</span><span class="s">info</span>
<span class="c"># org 包下的日志级别 指定默认的级别是 info ，但包名是 org 开头的类，日志级别是 warn 。 org 包名的类大多是第三方依赖库， 有时候没有必要显示 INFO 级别， com.xxx 开头的类使用 debug 。
</span><span class="py">logging.level.org</span><span class="p">=</span><span class="s">warn</span>
<span class="py">logging.level.com.xxx</span><span class="p">=</span><span class="s">debug</span>
<span class="c"># Spring Boot 默认井未输出日志到文件，可以指定日志输出
</span><span class="py">logging.file</span><span class="p">=</span><span class="s">my.log</span>
<span class="c"># 日志输出到 my.log 中，位于 Spring Boot 应用运行的当前目录，比如项目工程目录下，也
</span><span class="err">可以指定日志存放的路径</span>
<span class="py">logging.path</span><span class="p">=</span><span class="s">e:/temp/log</span>
<span class="c"># Spring Boot 支持对控制台日志输出和文件输出进行格式控制，代码如下（仅使用内置的 logback )
</span><span class="py">logging.pattern.console</span><span class="p">=</span><span class="s">%level %date{HH:mm : ss} %logger{20}. %M %L:%m%n</span>
<span class="py">logging.pattern.file</span><span class="p">=</span><span class="s">%level %date{IS08601} [%thread]%logger {20}.%M %L:%m%n</span>

<span class="err">•</span> <span class="err">%level</span> <span class="err">，</span> <span class="err">表示输出日志级别。</span>
<span class="err">•</span> <span class="err">%date</span> <span class="err">，表示日志发生时的时间，</span> <span class="py">HH</span><span class="p">:</span><span class="s">mm：“输出时分秒，比较合适用于控制台查看，IS08601 则是标准日期输出 ，相当于 yyyy-MM-dd HH:mm:ss.SSS 。</span>
<span class="err">•</span> <span class="err">%logger</span> <span class="err">，</span> <span class="err">用于输出Logger</span> <span class="err">的名字，包名＋类名，{n}</span> <span class="err">限定了输出长度，如果输出长度不够，尽可能显示类名、压缩包名。</span>
<span class="err">•</span> <span class="err">%thread</span> <span class="err">，当前线程名。</span>
<span class="err">•</span> <span class="err">%L</span> <span class="err">，日志调用所在代码行，线上运行时不建议使用此参数，因为获取代码行对性能有消耗。</span>
<span class="err">•</span> <span class="err">%p</span> <span class="err">，</span> <span class="err">输出日志信息的优先级，即DEBUG，INFO，WARN，ERROR，FATAL。</span>
<span class="err">•</span> <span class="err">%d</span> <span class="err">，</span> <span class="err">输出日志时间点的日期或时间，默认格式为ISO8601，也可以在其后指定格式，如</span> <span class="err">，</span> <span class="err">%d{yyyy/MM/</span><span class="py">ddHH</span><span class="p">:</span><span class="s">mm:ss,SSS}。</span>
<span class="err">•</span> <span class="err">%r</span> <span class="err">，</span> <span class="err">输出自应用程序启动到输出该log信息耗费的毫秒数。</span>
<span class="err">•</span> <span class="err">%t</span> <span class="err">，</span> <span class="err">输出产生该日志事件的线程名。</span>
<span class="err">•</span> <span class="err">%l</span> <span class="err">，</span> <span class="err">输出日志事件的发生位置，相当于%c.%M(%</span><span class="py">F</span><span class="p">:</span><span class="s">%L)的组合，包括类全名、方法、文件名以及在代码中的行数。例如 ， test.TestLog4j.main(TestLog4j.java:10)。</span>
<span class="err">•</span> <span class="err">%c</span> <span class="err">，</span> <span class="err">输出日志信息所属的类目，通常就是所在类的全名。</span>
<span class="err">•</span> <span class="err">%M</span> <span class="err">，</span> <span class="err">输出产生日志信息的方法名。</span>
<span class="err">•</span> <span class="err">%F</span> <span class="err">，</span> <span class="err">输出日志消息产生时所在的文件名称。</span>
<span class="err">•</span> <span class="err">%</span><span class="py">m</span><span class="p">:</span> <span class="s">， 输出代码中指定的具体日志信息。</span>
<span class="err">•</span> <span class="err">%n</span> <span class="err">，</span> <span class="err">输出一个回车换行符，Windows平台为"\r\n"，Unix平台为"\n"。</span>
<span class="err">•</span> <span class="err">%x</span> <span class="err">，</span> <span class="err">输出和当前线程相关联的NDC(嵌套诊断环境)，尤其用到像</span> <span class="err">java</span> <span class="err">servlets</span> <span class="err">这样的多客户多线程的应用中。</span>
<span class="err">•</span> <span class="err">%%</span> <span class="err">，</span> <span class="err">输出一个"%"字符。</span>
<span class="err">•</span> <span class="err">另外，还可以在%与格式字符之间加上修饰符来控制其最小长度、最大长度、和文本的对齐方式。如</span> <span class="err">，</span>
	<span class="err">1)</span> <span class="err">c</span> <span class="err">，</span> <span class="err">指定输出category的名称，最小的长度是20，如果category的名称长度小于20的话，默认的情况下右对齐。</span>
	<span class="err">2)%-20c</span> <span class="err">，</span> <span class="err">"-"号表示左对齐。</span>
	<span class="err">3)%.30c</span> <span class="err">，</span> <span class="err">指定输出category的名称，最大的长度是30，如果category的名称长度大于30的话，就会将左边多出的字符截掉，但小于30的话也不会补空格。</span>
</code></pre>
</div>

<p>也可以通过在 resources 目录下使用 logback.xml 或者 logback-spring.xml 来对 Logback 进行更详细的配置。</p>

<ul>
  <li>org.apache.log4j.ConsoleAppender（控制台）</li>
  <li>org.apache.log4j.FileAppender（文件）</li>
  <li>org.apache.log4j.DailyRollingFileAppender（每天产生一个日志文件）</li>
  <li>org.apache.log4j.RollingFileAppender（文件大小到达指定尺寸的时候产生一个新的文件）</li>
  <li>org.apache.log4j.WriterAppender（将日志信息以流格式发送到任意指定的地方）</li>
</ul>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;included&gt;</span>
	<span class="nt">&lt;include</span> <span class="na">resource=</span><span class="s">"org/springframework/boot/logging/logback/defaults.xml"</span><span class="nt">/&gt;</span>

	<span class="nt">&lt;springProperty</span> <span class="na">scope=</span><span class="s">"context"</span> <span class="na">name=</span><span class="s">"springAppName"</span> <span class="na">source=</span><span class="s">"spring.application.name"</span><span class="nt">/&gt;</span>
	<span class="nt">&lt;springProperty</span> <span class="na">scope=</span><span class="s">"context"</span> <span class="na">name=</span><span class="s">"destination"</span> <span class="na">source=</span><span class="s">"logstash.destination"</span><span class="nt">/&gt;</span>
	<span class="nt">&lt;springProperty</span> <span class="na">scope=</span><span class="s">"context"</span> <span class="na">name=</span><span class="s">"kafkadestination"</span> <span class="na">source=</span><span class="s">"kafka.destination"</span><span class="nt">/&gt;</span>
	<span class="nt">&lt;conversionRule</span> <span class="na">conversionWord=</span><span class="s">"ip"</span> <span class="na">converterClass=</span><span class="s">"cn.xxx.IPLogConfig"</span> <span class="nt">/&gt;</span>
	<span class="c">&lt;!-- Example for logging into the build folder of your project --&gt;</span>
	<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"LOG_FILE"</span> <span class="na">value=</span><span class="s">"${log_file_path:-build}/logs/${springAppName}/${hostname}/${springAppName}"</span><span class="nt">/&gt;</span>​

	<span class="c">&lt;!-- You can override this to have a custom pattern --&gt;</span>
	<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"CONSOLE_LOG_PATTERN"</span>
				<span class="na">value=</span><span class="s">"%clr(%d{yyyy-MM-dd HH:mm:ss.SSS}){faint} %clr(${LOG_LEVEL_PATTERN:-%5p}) %clr(${PID:- }){magenta} %clr(---){faint} %clr([%15.15t]){faint} %clr(%-40.40logger{39}){cyan} %clr(:){faint} %m%n${LOG_EXCEPTION_CONVERSION_WORD:-%wEx}"</span><span class="nt">/&gt;</span>

	<span class="c">&lt;!-- Appender to log to console --&gt;</span>
	<span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">"console"</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.ConsoleAppender"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;filter</span> <span class="na">class=</span><span class="s">"ch.qos.logback.classic.filter.ThresholdFilter"</span><span class="nt">&gt;</span>
			<span class="c">&lt;!-- Minimum logging level to be presented in the console logs--&gt;</span>
			<span class="nt">&lt;level&gt;</span>DEBUG<span class="nt">&lt;/level&gt;</span>
		<span class="nt">&lt;/filter&gt;</span>
		<span class="nt">&lt;encoder&gt;</span>
			<span class="nt">&lt;pattern&gt;</span>${CONSOLE_LOG_PATTERN}<span class="nt">&lt;/pattern&gt;</span>
			<span class="nt">&lt;charset&gt;</span>utf8<span class="nt">&lt;/charset&gt;</span>
		<span class="nt">&lt;/encoder&gt;</span>
	<span class="nt">&lt;/appender&gt;</span>

	<span class="c">&lt;!-- Appender to log to file --&gt;</span>​
	<span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">"flatfile"</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.rolling.RollingFileAppender"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;file&gt;</span>${LOG_FILE}<span class="nt">&lt;/file&gt;</span>
		<span class="nt">&lt;rollingPolicy</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span><span class="nt">&gt;</span>
			<span class="nt">&lt;fileNamePattern&gt;</span>${LOG_FILE}.%d{yyyy-MM-dd}.gz<span class="nt">&lt;/fileNamePattern&gt;</span>
			<span class="nt">&lt;maxHistory&gt;</span>7<span class="nt">&lt;/maxHistory&gt;</span>
		<span class="nt">&lt;/rollingPolicy&gt;</span>
		<span class="nt">&lt;encoder&gt;</span>
			<span class="nt">&lt;pattern&gt;</span>${CONSOLE_LOG_PATTERN}<span class="nt">&lt;/pattern&gt;</span>
			<span class="nt">&lt;charset&gt;</span>utf8<span class="nt">&lt;/charset&gt;</span>
		<span class="nt">&lt;/encoder&gt;</span>
	<span class="nt">&lt;/appender&gt;</span>

	<span class="c">&lt;!-- Appender to log to file in a JSON format --&gt;</span>
	<span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">"logstashFile"</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.rolling.RollingFileAppender"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;file&gt;</span>${LOG_FILE}.json<span class="nt">&lt;/file&gt;</span>
		<span class="nt">&lt;rollingPolicy</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span><span class="nt">&gt;</span>
			<span class="nt">&lt;fileNamePattern&gt;</span>${LOG_FILE}.json.%d{yyyy-MM-dd}.gz<span class="nt">&lt;/fileNamePattern&gt;</span>
			<span class="nt">&lt;maxHistory&gt;</span>7<span class="nt">&lt;/maxHistory&gt;</span>
		<span class="nt">&lt;/rollingPolicy&gt;</span>
		<span class="nt">&lt;encoder</span> <span class="na">class=</span><span class="s">"net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder"</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
			<span class="c">&lt;!-- 使用自定义的JsonFactory的装饰器,禁用jackson对非ascii码字符进行escape编码 --&gt;</span>
			<span class="nt">&lt;jsonFactoryDecorator</span> <span class="na">class=</span><span class="s">"org.xxx.MyJsonFactoryDecorator"</span><span class="nt">/&gt;</span>
			<span class="nt">&lt;providers&gt;</span>
				<span class="nt">&lt;timestamp&gt;</span>
					<span class="nt">&lt;timeZone&gt;</span>UTC<span class="nt">&lt;/timeZone&gt;</span>
				<span class="nt">&lt;/timestamp&gt;</span>
				<span class="nt">&lt;pattern&gt;</span>
					<span class="nt">&lt;pattern&gt;</span>
						{
						"createTime": "%d{yyyy-MM-dd HH:mm:ss.SSS}",
						"severity": "%level",
						"service": "${springAppName:-}",
						"trace": "%X{X-B3-TraceId:-}",
						"span": "%X{X-B3-SpanId:-}",
						"parent": "%X{X-B3-ParentSpanId:-}",
						"exportable": "%X{X-Span-Export:-}",
						"pid": "${PID:-}",
						"restUrl":"%X{restUrl}",
						"thread": "%thread",
						"class": "%logger{40}",
						"line_number": "%line",
						"info": "%message",
						"stack_trace": "%exception{5}",
						"host":"%ip"
						}
					<span class="nt">&lt;/pattern&gt;</span>
				<span class="nt">&lt;/pattern&gt;</span>
				<span class="nt">&lt;stackTrace&gt;</span>
					<span class="nt">&lt;throwableConverter</span> <span class="na">class=</span><span class="s">"net.logstash.logback.stacktrace.ShortenedThrowableConverter"</span><span class="nt">&gt;</span>
						<span class="nt">&lt;maxDepthPerThrowable&gt;</span>2<span class="nt">&lt;/maxDepthPerThrowable&gt;</span>
						<span class="nt">&lt;maxLength&gt;</span>2048<span class="nt">&lt;/maxLength&gt;</span>
						<span class="nt">&lt;rootCauseFirst&gt;</span>true<span class="nt">&lt;/rootCauseFirst&gt;</span>
					<span class="nt">&lt;/throwableConverter&gt;</span>
				<span class="nt">&lt;/stackTrace&gt;</span>
			<span class="nt">&lt;/providers&gt;</span>
		<span class="nt">&lt;/encoder&gt;</span>
	<span class="nt">&lt;/appender&gt;</span>

	<span class="c">&lt;!-- Appender to log to file in a JSON format --&gt;</span>
	<span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">"logstash"</span> <span class="na">class=</span><span class="s">"net.logstash.logback.appender.LogstashTcpSocketAppender"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;destination&gt;</span>${destination}<span class="nt">&lt;/destination&gt;</span>
		<span class="nt">&lt;encoder</span> <span class="na">class=</span><span class="s">"net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder"</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
			<span class="c">&lt;!-- 使用自定义的JsonFactory的装饰器,禁用jackson对非ascii码字符进行escape编码 --&gt;</span>
			<span class="nt">&lt;jsonFactoryDecorator</span> <span class="na">class=</span><span class="s">"org.xxx.MyJsonFactoryDecorator"</span><span class="nt">/&gt;</span>
			<span class="nt">&lt;providers&gt;</span>
				<span class="nt">&lt;timestamp&gt;</span>
					<span class="nt">&lt;timeZone&gt;</span>UTC<span class="nt">&lt;/timeZone&gt;</span>
				<span class="nt">&lt;/timestamp&gt;</span>
				<span class="nt">&lt;pattern&gt;</span>
					<span class="nt">&lt;pattern&gt;</span>
						{
						"createTime": "%d{yyyy-MM-dd HH:mm:ss.SSS}",
						"severity": "%level",
						"service": "${springAppName:-}",
						"trace": "%X{X-B3-TraceId:-}",
						"span": "%X{X-B3-SpanId:-}",
						"parent": "%X{X-B3-ParentSpanId:-}",
						"exportable": "%X{X-Span-Export:-}",
						"pid": "${PID:-}",
						"restUrl":"%X{restUrl}",
						"thread": "%thread",
						"clazz": "%logger{40}",
						"linenumber": "%line",
						"info": "%message",
						"stacktrace": "%exception{5}",
						"host":"%ip"
						}
					<span class="nt">&lt;/pattern&gt;</span>
				<span class="nt">&lt;/pattern&gt;</span>
			<span class="nt">&lt;/providers&gt;</span>
		<span class="nt">&lt;/encoder&gt;</span>
	<span class="nt">&lt;/appender&gt;</span>

	<span class="c">&lt;!-- This is the kafkaAppender --&gt;</span>
	<span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">"kafkaAppender"</span> <span class="na">class=</span><span class="s">"com.github.danielwegener.logback.kafka.KafkaAppender"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;encoder</span> <span class="na">class=</span><span class="s">"net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder"</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
			<span class="c">&lt;!-- 使用自定义的JsonFactory的装饰器,禁用jackson对非ascii码字符进行escape编码 --&gt;</span>
			<span class="nt">&lt;jsonFactoryDecorator</span> <span class="na">class=</span><span class="s">"org.xxx.MyJsonFactoryDecorator"</span><span class="nt">/&gt;</span>
			<span class="nt">&lt;providers&gt;</span>
				<span class="nt">&lt;timestamp&gt;</span>
					<span class="nt">&lt;timeZone&gt;</span>UTC<span class="nt">&lt;/timeZone&gt;</span>
				<span class="nt">&lt;/timestamp&gt;</span>
				<span class="nt">&lt;pattern&gt;</span>
					<span class="nt">&lt;pattern&gt;</span>
						{
						"createTime": "%d{yyyy-MM-dd HH:mm:ss.SSS}",
						"severity": "%level",
						"service": "${springAppName:-}",
						"trace": "%X{X-B3-TraceId:-}",
						"span": "%X{X-B3-SpanId:-}",
						"parent": "%X{X-B3-ParentSpanId:-}",
						"exportable": "%X{X-Span-Export:-}",
						"pid": "${PID:-}",
						"restUrl":"%X{restUrl}",
						"thread": "%thread",
						"clazz": "%logger{40}",
						"linenumber": "%line",
						"info": "%message",
						"stacktrace": "%exception{5}",
						"host":"%ip"
						}
					<span class="nt">&lt;/pattern&gt;</span>
				<span class="nt">&lt;/pattern&gt;</span>
			<span class="nt">&lt;/providers&gt;</span>
		<span class="nt">&lt;/encoder&gt;</span>
		<span class="nt">&lt;topic&gt;</span>logs<span class="nt">&lt;/topic&gt;</span>
		<span class="nt">&lt;keyingStrategy</span> <span class="na">class=</span><span class="s">"com.github.danielwegener.logback.kafka.keying.NoKeyKeyingStrategy"</span><span class="nt">/&gt;</span>
		<span class="nt">&lt;deliveryStrategy</span> <span class="na">class=</span><span class="s">"com.github.danielwegener.logback.kafka.delivery.AsynchronousDeliveryStrategy"</span><span class="nt">/&gt;</span>

		<span class="c">&lt;!-- Optional parameter to use a fixed partition --&gt;</span>
		<span class="c">&lt;!-- &lt;partition&gt;0&lt;/partition&gt; --&gt;</span>

		<span class="c">&lt;!-- Optional parameter to include log timestamps into the kafka message --&gt;</span>
		<span class="c">&lt;!-- &lt;appendTimestamp&gt;true&lt;/appendTimestamp&gt; --&gt;</span>

		<span class="c">&lt;!-- each &lt;producerConfig&gt; translates to regular kafka-client config (format: key=value) --&gt;</span>
		<span class="c">&lt;!-- producer configs are documented here: https://kafka.apache.org/documentation.html#newproducerconfigs --&gt;</span>
		<span class="c">&lt;!-- bootstrap.servers is the only mandatory producerConfig --&gt;</span>
		<span class="nt">&lt;producerConfig&gt;</span>bootstrap.servers=${kafkadestination}<span class="nt">&lt;/producerConfig&gt;</span>

		<span class="c">&lt;!-- this is the fallback appender if kafka is not available. --&gt;</span>
		<span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">"flatfile"</span><span class="nt">/&gt;</span>
	<span class="nt">&lt;/appender&gt;</span>

	<span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">"ASYNC"</span> <span class="na">class=</span><span class="s">"ch.qos.logback.classic.AsyncAppender"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">"kafkaAppender"</span> <span class="nt">/&gt;</span>
	<span class="nt">&lt;/appender&gt;</span>

	<span class="c">&lt;!--生产环境--&gt;</span>
	<span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">"druid.sql.Statement"</span> <span class="na">level=</span><span class="s">"DEBUG"</span><span class="nt">/&gt;</span>
	<span class="nt">&lt;root</span> <span class="na">level=</span><span class="s">"INFO"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">"console"</span><span class="nt">/&gt;</span>
		<span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">"ASYNC"</span><span class="nt">/&gt;</span>
	<span class="nt">&lt;/root&gt;</span>
	<span class="nt">&lt;jmxConfigurator/&gt;</span>
<span class="nt">&lt;/included&gt;</span>
</code></pre>
</div>

<h2 id="heading-打包配置">打包配置</h2>

<p>1.以 jar 文件运行</p>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;build&gt;</span>
	<span class="nt">&lt;plugins&gt;</span>
		<span class="nt">&lt;plugin&gt;</span>
		<span class="nt">&lt;groupid&gt;</span>org.springframework.boot<span class="nt">&lt;/groupid&gt;</span>
		<span class="nt">&lt;artifactid&gt;</span>spring-boot-maven-plugin<span class="nt">&lt;/artifactid&gt;</span>
		<span class="nt">&lt;configuration&gt;</span>
			<span class="nt">&lt;executable&gt;</span>true<span class="nt">&lt;/executable&gt;</span>
		<span class="nt">&lt;/configuration&gt;</span>
		<span class="nt">&lt;/plugin&gt;</span>
	<span class="nt">&lt;/plugins&gt;</span>
<span class="nt">&lt;/build&gt;</span>
</code></pre>
</div>

<p>2.以 war 方式部署</p>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;project</span> <span class="err">...</span><span class="nt">&gt;</span>
	<span class="nt">&lt;artifactid&gt;</span>ch8.deploy<span class="nt">&lt;/artifactid&gt;</span>
	<span class="nt">&lt;version&gt;</span>0.0.1-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
	<span class="nt">&lt;packaging&gt;</span>war<span class="nt">&lt;/packaging&gt;</span>
<span class="nt">&lt;/project&gt;</span>

<span class="nt">&lt;dependencies&gt;</span>
	<span class="err">&lt;</span> !--…--&gt;
	<span class="nt">&lt;dependency&gt;</span>
		<span class="nt">&lt;groupid&gt;</span>org.springframework.boot<span class="nt">&lt;/groupid&gt;</span>
		<span class="nt">&lt;artifactid&gt;</span>spring-boot-starter-tomcat<span class="nt">&lt;/artifactid&gt;</span>
		<span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
	<span class="nt">&lt;/dependency&gt;</span>
	<span class="c">&lt;!--...--&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
</code></pre>
</div>

<p>另外 启动类还要实现 SpringBootServletinitializer</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Ch8Application</span> <span class="kd">extends</span> <span class="n">SpringBootServletinitializer</span> <span class="o">{</span>
	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="n">SpringApplicationBuilder</span> <span class="nf">configure</span><span class="o">(</span><span class="n">SpringApplicationBuilder</span> <span class="n">application</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">application</span><span class="o">.</span><span class="na">sources</span><span class="o">(</span><span class="n">Ch8Application</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">Ch8Application</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span> <span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h2 id="heading-多环境部署">多环境部署</h2>

<p>需要在 resource 下创建 application-{profile}.properties 的配置文件， 其中 profile 可以是任意名字，比如：</p>

<ul>
  <li>test ， 表示测试环境</li>
  <li>prod ，表示线上环境</li>
  <li>pre-prod ， 预发布环境</li>
  <li>demo1.0 ， 1.0 版本演示环境</li>
</ul>

<p>在环境变量中， spring.profiles.active 指定使用哪个profile ， 比如：</p>
<pre><code class="language-cmd">java -jar -Dspring.profiles.active=prod target/ch8.deploy-0.0.1-SNAPSHOT.jar
</code></pre>

<p>以上配置启动后， Spring Boot 将读取 resources/application-prod.properties 配置文件，覆盖默认的application. properties 选项。application. properties 的内容如下：</p>

<div class="language-properties highlighter-rouge"><pre class="highlight"><code><span class="py">server.port</span><span class="p">=</span><span class="s">8080</span>
</code></pre>
</div>

<p>application-prod.properties 的内容如下：</p>
<div class="language-properties highlighter-rouge"><pre class="highlight"><code><span class="py">server.port</span><span class="p">=</span><span class="s">9000</span>
</code></pre>
</div>

<p>如果使用 war 方式部署， 添加系统属性是比较好的方式，下面以 Tomcat 为例进行说明。编辑 catalina.sh ， 在sh 文件的开头部分添加如下内容：</p>
<div class="language-shell highlighter-rouge"><pre class="highlight"><code>JAVA_OPTS <span class="o">=</span><span class="s2">"-Dspring.profiles.active=prod"</span>
</code></pre>
</div>

<p>在多环境部署中，通常 resources 目录下可能没有目标环境的配置文件 ，这主要是为了安全考虑，开发环境不应该有线上环境的各种配置信息。可以将配置文件放到特定的目录中，并用 spring.config.location 指定配置文件的目录：</p>
<pre><code class="language-cmd">java -jar -Dspring.config.location=file:env/ -Dspring.profiles.active=test target/ch8.deploy-0.0.1-SNAPSHOT.jar
</code></pre>

<p>@Profile 搭配 @Bean 、@Configuration 等自动执行配置可以定义在不同环境下是否生效，例如：</p>

<ul>
  <li>@Profile({"test", "prod"}) ，测试环境和线上环境生效</li>
  <li>@Profile({"test", "!prod"}) ，测试环境和非线上环境生效</li>
</ul>

<h2 id="heading-测试用例">测试用例</h2>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre>
</div>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="nd">@RunWith</span><span class="o">(</span><span class="n">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="c1">// 需要测试的Controller</span>
<span class="nd">@WebMvcTest</span><span class="o">(</span><span class="n">UserController</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserControllerTest</span><span class="o">{</span>
	<span class="nd">@Autowired</span>
	<span class="kd">private</span> <span class="n">MockMvc</span> <span class="n">mvc</span><span class="o">;</span>
	<span class="nd">@MockBean</span>
	<span class="n">UserService</span> <span class="n">userService</span><span class="o">;</span>
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testMvc</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="kt">int</span> <span class="n">userid</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">;</span>
		<span class="kt">int</span> <span class="n">expectedCredit</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">;</span>
		<span class="c1">// 模拟userService</span>
		<span class="n">given</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">userService</span><span class="o">.</span><span class="na">getCredit</span><span class="o">(</span><span class="n">userid</span><span class="o">)).</span><span class="na">willReturn</span><span class="o">(</span><span class="n">l00</span><span class="o">);</span>
		<span class="c1">// mvc 调用</span>
		<span class="n">mvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">"user/{Id}"</span><span class="o">,</span> <span class="n">userid</span><span class="o">)).</span><span class="na">andExpect</span><span class="o">(</span><span class="n">content</span><span class="o">().</span><span class="na">string</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">expectedCredit</span><span class="o">)));</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h3 id="heading-mockmvc模拟请求">mockMvc模拟请求</h3>
<p>1.模拟一个Post请求：</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">mockMvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">"/hotels?foo={foo}"</span><span class="o">,</span><span class="s">"bar"</span><span class="o">));</span>
</code></pre>
</div>

<p>2.模拟一个Post请求：</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">mockMvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">post</span><span class="o">(</span><span class="s">"/hotels/{id}"</span><span class="o">,</span> <span class="mi">42</span><span class="o">);</span>
</code></pre>
</div>

<p>3.模拟文件上传：</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">mockMvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">multipart</span><span class="o">(</span><span class="s">"/doc"</span><span class="o">).</span><span class="na">file</span><span class="o">(</span><span class="s">"file"</span><span class="o">,</span><span class="s">"文件内容"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">)));</span>
</code></pre>
</div>

<p>4.模拟请求参数：</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="c1">//模拟提交message 参数</span>
<span class="n">mvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">"/user/{id}/{name}"</span><span class="o">,</span> <span class="n">userid</span><span class="o">,</span> <span class="n">name</span><span class="o">).</span><span class="na">param</span><span class="o">(</span><span class="s">"message"</span><span class="o">,</span><span class="s">"hello"</span><span class="o">));</span>
<span class="c1">//模拟一个checkbox提交</span>
<span class="n">mvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">"/user/{id}/{name}"</span><span class="o">,</span><span class="n">userid</span><span class="o">,</span><span class="n">name</span><span class="o">).</span><span class="na">param</span><span class="o">(</span><span class="s">"job"</span><span class="o">,</span><span class="s">"IT"</span><span class="o">,</span><span class="s">"gov"</span><span class="o">).</span><span class="na">param</span><span class="o">(...));</span>
<span class="c1">//直接使用MultiValueMap 构造参数</span>
<span class="n">LinkedMultiValueMap</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedMultiValueMap</span> <span class="o">()</span> <span class="o">;</span>
<span class="n">pararns</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"message"</span><span class="o">,</span><span class="s">"hello"</span><span class="o">);</span>
<span class="n">pararns</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"job"</span><span class="o">,</span><span class="s">"IT"</span><span class="o">);</span>
<span class="n">pararns</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"job"</span><span class="o">,</span><span class="s">"gov"</span><span class="o">);</span>
<span class="n">mvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">"/user/{id)/{narne}"</span><span class="o">,</span><span class="n">userid</span><span class="o">,</span><span class="n">name</span><span class="o">).</span><span class="na">param</span><span class="o">(</span><span class="n">params</span><span class="o">));</span>
</code></pre>
</div>

<p>5.模拟Session和Cookie:</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">mvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">"/user.html"</span><span class="o">).</span><span class="na">sessionAttr</span><span class="o">(</span><span class="n">name</span><span class="o">,</span><span class="n">value</span><span class="o">));</span>
<span class="n">mvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">"/user.html"</span><span class="o">).</span><span class="na">cookie</span><span class="o">(</span><span class="k">new</span> <span class="n">Cookie</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">value</span><span class="o">)))</span> <span class="o">;</span>
</code></pre>
</div>

<p>6.设置HTTP Body 内容，比如提交的JSON:</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">String</span> <span class="n">json</span> <span class="o">=</span> <span class="n">mvc</span><span class="o">.</span><span class="na">perforrn</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">"/user.html"</span><span class="o">).</span><span class="na">content</span><span class="o">(</span><span class="n">json</span><span class="o">));</span>
</code></pre>
</div>

<p>7.设置HTTP Header:</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">mvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">"/user/{id}/{narne}"</span><span class="o">,</span><span class="n">userid</span><span class="o">,</span><span class="n">narne</span><span class="o">)</span>
	<span class="o">.</span><span class="na">contentType</span><span class="o">(</span><span class="s">"application/x-www-forrn-urlencoded"</span><span class="o">)</span><span class="c1">//HTTP提交内容</span>
	<span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="s">"application/json"</span><span class="o">)</span><span class="c1">//期望返回内容</span>
	<span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="n">headerl</span><span class="o">,</span><span class="n">valuel</span><span class="o">));</span> <span class="c1">//设直HTTP头</span>
</code></pre>
</div>

<h3 id="heading-mockito模拟数据">Mockito模拟数据</h3>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="nd">@RunWith</span><span class="o">(</span><span class="n">MockitoJUnitRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CreditServiceMockTest</span><span class="o">{</span>
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">(){</span>
		<span class="kt">int</span> <span class="n">userid</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
		<span class="c1">//创建Mock 对象</span>
		<span class="n">CreditSystemService</span> <span class="n">creditService</span><span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">CreditSystemService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="c1">//模拟Mock 对象调用，传入任何 int 位都将返回1000 积分</span>
		<span class="n">when</span><span class="o">(</span><span class="n">creditServrice</span><span class="o">.</span><span class="na">getUserCredit</span><span class="o">(</span><span class="n">anyInt</span><span class="o">())).</span><span class="na">thenReturn</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
		<span class="c1">//when(creditService.getUserCredit(any(int.class))).thenReturn(1OOO);</span>
		<span class="c1">//实际调用</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">creditService</span><span class="o">.</span><span class="na">getUserCredit</span><span class="o">(</span><span class="n">lO</span><span class="o">);</span>
		<span class="c1">// 比较期望值和返回佳</span>
		<span class="n">assertEquals</span><span class="o">(</span><span class="mi">1000</span> <span class="o">,</span> <span class="n">ret</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h2 id="heading-集成swagger">集成Swagger</h2>

<h3 id="heading-swagger2">Swagger2</h3>

<p>1.Maven依赖添加</p>
<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>io.springfox<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>springfox-swagger2<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;version&gt;</span>2.6.1<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>io.springfox<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>springfox-swagger-ui<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;version&gt;</span>2.6.1<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre>
</div>
<p>2.配置添加</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@EnableSwagger2</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Swagger2</span> <span class="o">{</span>
	<span class="nd">@Bean</span>
	<span class="kd">public</span> <span class="n">Docket</span> <span class="nf">createRestApi</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">Docket</span><span class="o">(</span><span class="n">DocumentationType</span><span class="o">.</span><span class="na">SWAGGER_2</span><span class="o">)</span>
				<span class="o">.</span><span class="na">apiInfo</span><span class="o">(</span><span class="n">apiInfo</span><span class="o">())</span>
				<span class="o">.</span><span class="na">select</span><span class="o">()</span>
				<span class="o">.</span><span class="na">apis</span><span class="o">(</span><span class="n">RequestHandlerSelectors</span><span class="o">.</span><span class="na">basePackage</span><span class="o">(</span><span class="s">"com.test.controller"</span><span class="o">))</span>
				<span class="o">.</span><span class="na">paths</span><span class="o">(</span><span class="n">PathSelectors</span><span class="o">.</span><span class="na">any</span><span class="o">())</span>
				<span class="o">.</span><span class="na">build</span><span class="o">();</span>
	<span class="o">}</span>
	<span class="kd">private</span> <span class="n">ApiInfo</span> <span class="nf">apiInfo</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">ApiInfoBuilder</span><span class="o">()</span>
				<span class="o">.</span><span class="na">title</span><span class="o">(</span><span class="s">"SpringBoot利用Swagger构建Api文档"</span><span class="o">)</span>
				<span class="o">.</span><span class="na">description</span><span class="o">(</span><span class="s">"简单优雅的Restfun风格，http://localhost:8000/swagger-ui.html"</span><span class="o">)</span>
				<span class="o">.</span><span class="na">termsOfServiceUrl</span><span class="o">(</span><span class="s">"http://localhost:8000/swagger-ui.html"</span><span class="o">)</span>
				<span class="o">.</span><span class="na">version</span><span class="o">(</span><span class="s">"1.0"</span><span class="o">)</span>
				<span class="o">.</span><span class="na">build</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>
<p>3.添加文档描述</p>
<ul>
  <li>@Api：修饰整个类，描述Controller的作用</li>
  <li>@ApiOperation：描述一个类的一个方法，或者说一个接口</li>
  <li>@ApiParam：单个参数描述</li>
  <li>@ApiModel：用对象来接收参数</li>
  <li>@ApiProperty：用对象接收参数时，描述对象的一个字段</li>
  <li>@ApiResponse：HTTP响应其中1个描述</li>
  <li>@ApiResponses：HTTP响应整体描述</li>
  <li>@ApiIgnore：使用该注解忽略这个API</li>
  <li>@ApiError ：发生错误返回的信息</li>
  <li>@ApiParamImplicitL：一个请求参数</li>
  <li>@ApiParamsImplicit 多个请求参数</li>
</ul>

<h3 id="heading-swagger3">Swagger3</h3>

<p><a href="https://swagger.io/blog/news/announcing-openapi-3-0/">了解学习</a></p>

<h2 id="heading-集成-mongodb">集成 MongoDB</h2>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-mongodb<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre>
</div>

<p>还需要在配置文件 application.properties 中配置：</p>

<div class="language-properties highlighter-rouge"><pre class="highlight"><code><span class="py">spring.data.mongodb.uri</span><span class="p">=</span><span class="s">mongodb://127.0.0.1:27017/baike</span>
<span class="c">#若开启了登陆功能，test是内置数据库名，123%abc!是密码，% 字符在 URI 中使用 %25
</span><span class="py">spring.data.mongodb.uri</span><span class="p">=</span><span class="s">mongodb ://test:123%25abc!@127.0.0.1:27017/baike</span>
</code></pre>
</div>

<h2 id="heading-集成-redis">集成 Redis</h2>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre>
</div>

<p>还需要在配置文件 application.properties 中配置：</p>

<div class="language-properties highlighter-rouge"><pre class="highlight"><code><span class="py">spring.redis.host</span><span class="p">=</span><span class="s">127.0.0.1</span>
<span class="py">spring.redis.password</span><span class="p">=</span><span class="s">Redis!l23</span>
<span class="py">spring.redis.port</span><span class="p">=</span><span class="s">6379</span>
<span class="c">#最大连接数
</span><span class="err">spring.redis.pool.max-</span><span class="py">active</span><span class="p">=</span><span class="s">8</span>
</code></pre>
</div>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="nd">@Autowired</span>
<span class="kd">private</span> <span class="n">StringRedisTemplate</span> <span class="n">redisClient</span><span class="o">;</span>

<span class="n">redisClient</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="s">"key1"</span><span class="o">,</span> <span class="n">value1</span><span class="o">);</span>
<span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="n">redisClient</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"key1"</span><span class="o">);</span>
</code></pre>
</div>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="nd">@Autowired</span>
<span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"redisTemplate"</span><span class="o">)</span>
<span class="kd">private</span> <span class="n">RedisTernplate</span> <span class="n">redisClient</span><span class="o">;</span>

<span class="n">redisClient</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span> <span class="o">(</span><span class="s">"key1"</span><span class="o">,</span> <span class="n">User</span><span class="o">.</span><span class="na">getSampleUser</span><span class="o">());</span>
<span class="n">User</span> <span class="n">uer</span> <span class="o">=</span> <span class="o">(</span><span class="n">User</span><span class="o">)</span><span class="n">redisClient</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"key1"</span><span class="o">);</span>
</code></pre>
</div>

<h2 id="heading-集成-elasticsearch">集成 Elasticsearch</h2>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-elasticsearch<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre>
</div>

<p>还需要在配置文件 application.properties 中配置：</p>
<div class="language-properties highlighter-rouge"><pre class="highlight"><code><span class="err">spring.data.elasticsearch.cluster-</span><span class="py">nodes</span><span class="p">=</span><span class="s">127.0.0.1:9300</span>
</code></pre>
</div>

<p>使用方法详细参考：</p>
<ul>
  <li>https://docs.spring.io/spring-data/elasticsearch/docs/current/reference/html/#repositories.query-methods</li>
  <li>https://www.cnblogs.com/Alandre/p/7055838.html</li>
</ul>

<h2 id="heading-集成-spring-cache">集成 Spring Cache</h2>

<p>1.添加 Maven 依赖</p>
<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-cache<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre>
</div>

<p>2.还需要在配置文件 application.properties 中配置：</p>

<div class="language-properties highlighter-rouge"><pre class="highlight"><code><span class="c">#使用 Spring Boot 自带的缓存
</span><span class="py">spring.cache.type</span><span class="p">=</span><span class="s">Simple</span>

<span class="err">•</span> <span class="err">Simple，基于</span> <span class="err">ConcurrentHashMap</span> <span class="err">实现的缓存，适合单体应用或者开发环境使用</span>
<span class="err">•</span> <span class="err">none，关闭缓存，比如开发阶段为了确保功能正确，可以先禁止使用缓存</span>
<span class="err">•</span> <span class="err">redis，使用</span> <span class="err">Redis</span> <span class="err">作为缓存，还需要在</span> <span class="err">porn</span> <span class="err">中增加</span> <span class="err">Redis</span> <span class="err">依赖</span>
<span class="err">•</span> <span class="err">Generic，用户自定义缓存实现，用户需要实现一个</span> <span class="err">org.springframework.cache.CacheManager</span> <span class="err">的实现</span>
<span class="err">•</span> <span class="err">其他还有</span> <span class="err">JCache、</span> <span class="err">EhCache</span> <span class="err">2.x,</span> <span class="err">Hazelcast</span> <span class="err">等</span>
</code></pre>
</div>

<p>3.要在启动类上添加 @EnableCaching 注解，打开缓存功能</p>

<p>4.注解驱动</p>

<ul>
  <li>@Cacheable，作用在方法上，触发缓存读取操作</li>
  <li>@CacheEvict，作用在方法上，触发缓存失效操作</li>
  <li>@CachePut，作用在方法上，触发缓存更新操作</li>
  <li>@Cache，作用在方法上，综合上面的各种操作，在有些场景下，调用业务会触发多种缓存操作</li>
  <li>@CacheConfig，在类上设置当前缓存的一些公共设置</li>
</ul>

<h3 id="heading-集成-redis-缓存">集成 Redis 缓存</h3>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre>
</div>

<p>还需要在配置文件 application.properties 中配置：</p>

<div class="language-properties highlighter-rouge"><pre class="highlight"><code><span class="py">spring.cache.type</span><span class="p">=</span><span class="s">Redis</span>
<span class="py">spring.redis.host</span><span class="p">=</span><span class="s">127.0.0.1</span>
<span class="py">spring.redis.password</span><span class="p">=</span><span class="s">Redis!l23</span>
<span class="py">spring.redis.port</span><span class="p">=</span><span class="s">6379</span>
</code></pre>
</div>

<p>用法与自带缓存一致，注解驱动</p>

<h3 id="heading-redis-两级缓存">Redis 两级缓存</h3>

<p>由于网络访问 Redis 效率可能还比自带的缓存要低，RedisCacheManager 和 RedisCache 在访 问 Redis 之前，先访问一个 ConcurrentHashMap 实现的简单一级缓存，如果有缓存项，则返回 给应用，如果没有，再从 Redis 中取得，并将缓存对象放到一级缓存中。实现方法：扩展 RedisCacheManager 并且实现 Cache 接口，自 @Configuration 注入 @Bean 实现 CacheManager 服务，具体自行实验。</p>

<p>如今比较流行的做法是将 SpringBoot + Mybatis + Redis 二级缓存，在对应的 Mapper.xml 中注入你扩展实现 Cache 的类：</p>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;cache</span> <span class="na">type=</span><span class="s">"com.xxx.MybatisRedisCache"</span><span class="nt">/&gt;</span>
</code></pre>
</div>

<h2 id="heading-水平扩展">水平扩展</h2>

<p>一般情况下，SpringBoot 的同一个服务会部署多套，这样保证了：</p>

<ul>
  <li>单个应用者机不会停止服务，升级应用可以逐个升级而不必停止服务</li>
  <li>提高了应用整体的吞吐量</li>
</ul>

<h3 id="heading-配置-nginx">配置 Nginx</h3>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="err">http</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="err">include</span><span class="w"> </span><span class="err">mime.types;</span><span class="w">
	</span><span class="err">default</span><span class="w"> </span><span class="err">type</span><span class="w"> </span><span class="err">application/octet-stream;</span><span class="w">
	</span><span class="err">sendfile</span><span class="w"> </span><span class="err">on;</span><span class="w">
	</span><span class="err">keepalive</span><span class="w"> </span><span class="err">timeout</span><span class="w"> </span><span class="err">65;</span><span class="w">
	</span><span class="err">upstream</span><span class="w"> </span><span class="err">backend</span><span class="w"> </span><span class="err">{</span><span class="w">
		</span><span class="err">server</span><span class="w"> </span><span class="err">127.0.0.1:9000;</span><span class="w">
		</span><span class="err">server</span><span class="w"> </span><span class="err">127.0.0.1:9001;</span><span class="w">
	</span><span class="p">}</span><span class="w">
	</span><span class="err">server</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="err">listen</span><span class="w"> </span><span class="err">80</span><span class="w"> </span><span class="err">;</span><span class="w">
		</span><span class="err">server</span><span class="w"> </span><span class="err">name</span><span class="w"> </span><span class="err">localhost;</span><span class="w">
		</span><span class="err">location</span><span class="w"> </span><span class="err">/</span><span class="w"> </span><span class="err">{</span><span class="w">
			</span><span class="err">proxy</span><span class="w"> </span><span class="err">pass</span><span class="w"> </span><span class="err">http://backend;</span><span class="w">
		</span><span class="p">}</span><span class="w">
	</span><span class="err">}</span><span class="w">
</span><span class="err">}</span><span class="w">
</span></code></pre>
</div>

<h2 id="heading-spring-session">Spring Session</h2>

<div class="language-properties highlighter-rouge"><pre class="highlight"><code><span class="err">spring.session.store-</span><span class="py">type</span><span class="p">=</span><span class="s">Redis|JDBC|Hazelcast|none</span>
</code></pre>
</div>

<ul>
  <li>Redis, Session 数据存放 Redis 中，通常使用该方式存储 SESSION</li>
  <li>JDBC， 会话数据存放在数据库中，默认情况下 SPRING_SESSION 表存放 Session 基 本信息 ，如 sessionld 、创建时间、 最后一次访问时间等 ， SPING_SESSION ATTIBUTES 存放了 session 数据， ATTIBUTE_NAME 列保存了 Session 的 Key, ATTIBUTE_BYTES 列以字节形式保存了 Session 的 Value, Spring Session 会自动创 建这两张表</li>
  <li>Hazelcast, Session 数据存放到 Hazeleast</li>
  <li>None，禁用 Spring Session 功能</li>
</ul>

<p>Redis 里面查看 Session：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&gt;keys spring:session:*

&gt;hgetall "spring:session:sessions:863c7e73-8249-4780-a08e-Off2bdddda86"

&gt;HMGET "spring:session:sessions:863c7e73-8249-4780-a08e-Off2bdddda86"
</code></pre>
</div>

<p>Nginx + Redis ，水平扩展的 SpringBoot 服务，将 Session 存储在 Redis 后，即使一台服务器挂了，对应用户的 Session 也不会丢失，不需要重新登录等等。</p>

<h2 id="heading-集成-zookeeper">集成 ZooKeeper</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>• 自动重连，无须开发人员关心
• 提供简单的 API 来操作 zk 节点，还有 zk 事件， API 是链式操作风格
• Curator 实现了 ZooKeeper 提供的所有应用场景（除了两阶段提交〉，有以下实现
    。 领导节点选取
    。 分布式锁
    。 分布式读写锁
    。 共享信号量
    。 栅栏和双重 Double Barrier
    。 分布式计数器，支持 integer 和 long
    。 分布式队列和分布式优先级队列
    。 服务注册和发现
</code></pre>
</div>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>org.apache.curator<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>curator-recipes<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;version&gt;</span>2.12.0<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre>
</div>

<div class="language-properties highlighter-rouge"><pre class="highlight"><code><span class="py">zk.url</span><span class="p">=</span><span class="s">l27.0.0.1:2181</span>
</code></pre>
</div>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ZookeeperConf</span> <span class="o">{</span>
	<span class="nd">@Value</span> <span class="o">(</span><span class="s">"${zk.url}"</span><span class="o">)</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">zkUrl</span><span class="o">;</span>
	<span class="nd">@Bean</span>
	<span class="kd">public</span> <span class="n">CuratorFramework</span> <span class="nf">getCuratorFramework</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">RetryPolicy</span> <span class="n">retryPolicy</span> <span class="o">=</span><span class="k">new</span> <span class="n">ExponentialBackoffRetry</span><span class="o">(</span><span class="n">lOOO</span><span class="o">,</span> <span class="mi">3</span><span class="o">);</span>
		<span class="n">CuratorFramework</span> <span class="n">client</span><span class="o">=</span> <span class="n">CuratorFrameworkFactory</span><span class="o">.</span><span class="na">newClient</span><span class="o">(</span><span class="n">zkUrl</span><span class="o">,</span> <span class="n">retryPolicy</span><span class="o">)</span> <span class="o">;</span>
		<span class="n">client</span><span class="o">.</span><span class="na">getCuratorListenable</span><span class="o">().</span><span class="na">addListener</span><span class="o">(</span><span class="k">new</span> <span class="n">CuratorListener</span><span class="o">()</span> <span class="o">{</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">eventReceived</span><span class="o">(</span><span class="n">CuratorFramework</span> <span class="n">client</span><span class="o">,</span> <span class="n">CuratorEvent</span> <span class="n">event</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
				<span class="n">CuratorEventType</span> <span class="n">type</span><span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getType</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">CuratorEventType</span><span class="o">.</span><span class="na">WATCHED</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">WatchedEvent</span> <span class="n">we</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getWatchedEvent</span><span class="o">();</span>
					<span class="n">EventType</span> <span class="n">et</span> <span class="o">=</span> <span class="n">we</span><span class="o">.</span><span class="na">getType</span><span class="o">();</span>
					<span class="n">client</span><span class="o">.</span><span class="na">checkExists</span><span class="o">().</span><span class="na">watched</span><span class="o">().</span><span class="na">forPath</span><span class="o">(</span><span class="n">we</span><span class="o">.</span><span class="na">getPath</span><span class="o">());</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">});</span>
		<span class="n">client</span><span class="o">.</span><span class="na">start</span><span class="o">()</span> <span class="o">;</span>
		<span class="k">return</span> <span class="n">client</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h3 id="heading-分布式锁使用">分布式锁使用</h3>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="nd">@Autowired</span>
<span class="n">CuratorFramework</span> <span class="n">zkClient</span><span class="o">;</span>

<span class="n">publiC</span> <span class="kt">void</span> <span class="nf">makeOrderType</span><span class="o">(</span><span class="n">String</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="s">"/lock/order/"</span> <span class="o">+</span> <span class="n">type</span><span class="o">;</span>
	<span class="k">try</span><span class="o">{</span>
		<span class="n">InterProcessMutex</span> <span class="n">lock</span><span class="o">=</span> <span class="k">new</span> <span class="n">InterProcessMutex</span><span class="o">(</span><span class="n">zkClient</span><span class="o">,</span> <span class="n">path</span><span class="o">)</span> <span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">acquire</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">HOURS</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="c1">// 模拟耗时 5 秒</span>
				<span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">*</span><span class="mi">5</span><span class="o">);</span>
				<span class="c1">// 即使获得分布式锁，在实际业务处理过程中，也应该检查数据是否已经被处理</span>
			<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
				<span class="n">lock</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// zk 异常</span>
		<span class="n">ex</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>也可以通过注解来定义：</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="nd">@ClusterLock</span> <span class="o">(</span><span class="s">"/lock/order"</span><span class="o">)</span>
<span class="n">publiC</span> <span class="kt">void</span> <span class="nf">makeOrderType</span><span class="o">(</span><span class="n">String</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">try</span> <span class="o">{</span>
		<span class="c1">// 模拟耗时 5 秒</span>
		<span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">*</span><span class="mi">5</span><span class="o">);</span>
		<span class="c1">// 即使获得分布式锁，在实际业务处理过程中，也应该检查数据是否已经被处理</span>
	<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
		<span class="n">lock</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h3 id="heading-服务注册">服务注册</h3>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>org.apache.curator<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>curator-x-discovery<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;version&gt;</span>2.12.0<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre>
</div>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">registerSerivce</span> <span class="o">(</span><span class="n">CuratorFramework</span> <span class="n">client</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
	<span class="c1">// 构造一个服务描述</span>
	<span class="n">ServiceinstanceBuilder</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&gt;</span> <span class="n">service</span> <span class="o">=</span><span class="n">ServiceInstance</span><span class="o">.</span><span class="na">builder</span><span class="o">();</span>
	<span class="n">service</span><span class="o">.</span><span class="na">address</span><span class="o">(</span><span class="s">"192.168.1.100"</span><span class="o">);</span>
	<span class="n">service</span><span class="o">.</span><span class="na">port</span><span class="o">(</span><span class="mi">8080</span><span class="o">);</span>
	<span class="n">service</span><span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"book"</span><span class="o">);</span>
	<span class="n">Map</span> <span class="n">config</span> <span class="o">=</span><span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
	<span class="n">config</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"url"</span><span class="o">,</span><span class="s">"/api/v3/book"</span><span class="o">);</span>
	<span class="n">service</span><span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="n">config</span><span class="o">);</span>
	<span class="n">Serviceinstance</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&gt;</span> <span class="n">instance</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
	<span class="n">ServiceDiscovery</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&gt;</span> <span class="n">serviceDiscovery</span> <span class="o">=</span> <span class="n">ServiceDiscoveryBuilder</span><span class="o">.</span><span class="na">builder</span><span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">client</span><span class="o">(</span><span class="n">client</span><span class="o">)</span>
		<span class="o">.</span><span class="na">serializer</span><span class="o">(</span><span class="k">new</span> <span class="n">JsoninstanceSerializer</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&gt;(</span><span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">)).</span><span class="na">basePath</span><span class="o">(</span><span class="s">"/service"</span><span class="o">).</span><span class="na">build</span><span class="o">();</span><span class="c1">//服务注册</span>
	<span class="n">serviceDiscovery</span><span class="o">.</span><span class="na">registerService</span><span class="o">(</span><span class="n">instance</span><span class="o">);</span>
	<span class="n">serviceDiscovery</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
<span class="o">}</span>
</code></pre>
</div>

<h2 id="heading-应用监控">应用监控</h2>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>org.apache.curator<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre>
</div>

<p>配置文件添加如下配置：</p>

<div class="language-properties highlighter-rouge"><pre class="highlight"><code><span class="py">endpoints.default.web.enabled</span><span class="p">=</span><span class="s">true</span>
<span class="c">#设置系统监控的访问端口
</span><span class="py">management.port</span><span class="p">=</span><span class="s">8081</span>
<span class="c">#所有的监控都在 /application 下，你可以更改配置，修改成你想要的路径
#management.context-path=/manage
</span></code></pre>
</div>

<ul>
  <li>Http监控查看URL：http://localhost:8081/application/trace</li>
  <li>日志查看URL：http://localhost:8081/application/loggers
    <ul>
      <li>如果定义了日志文件，还可以查看日志文件：http://localhost:8081/application/logfile</li>
    </ul>
  </li>
  <li>线程核信息URL：http://localhost:8081/application/dump</li>
  <li>内存信息URL：http://localhost:8081/application/heapdump</li>
  <li>其他的有 mappings 、beans 监控映射和Bean</li>
  <li>health： 查看所在应用的健康状态， 如磁盘、数据源、 Redis、 Elasticsearch</li>
  <li>metrics： 显示 Spring Boot 的性能指标，如己有内存、未占用内存、垃圾回收次数、类 信息等</li>
  <li>env： 显示 Spring Boot 环境变量，如使用的 JDK 版本、加载的 jar 包、配置文件信息、 日志文件信息</li>
  <li>configprops： 所有＠ConfigurationProperties 注解的配置信息，如文件上传的最大允许 配置等</li>
  <li>autoconfig：显示所有自动装配类的报告，以及是什么原因导致自动装配成功或者不成功</li>
</ul>

                                </article>
                            </div>
                            <div style="clear: both;"></div>
                        </div>
                    </div>
                </div>
                <!-- 评论组件 -->
                <!-- 聚合所有评论组件 -->

<div class="misc-content">

<!-- emaction -->

<div style="margin-top: 10px;color: coral;border-top: 1px solid;border-bottom: 1px solid;">
<div style="float:left;">邀请标记你的阅读体验😉 ｜ → &nbsp;</div>
<emoji-reaction></emoji-reaction>
<div style="clear:both;"></div>
</div>
<script type="module" src="https://cdn.jsdelivr.net/gh/emaction/frontend.dist@1.0.7/bundle.js"></script>

<script type="text/javascript">
    $(document).ready(function() {
        $($("emoji-reaction")[0].shadowRoot).find("div.container").css("align-items","center");
    });
</script>

<!-- gitment -->

<!-- utterances -->

<script src="https://utteranc.es/client.js"
    repo="petterobam/blog"
    
    issue-term="pathname"
    
    theme=""
    crossorigin="anonymous"
    async></script>


</div>
            </div>
        </div>
        <footer class="the-footer">
    <div class="unit-foot">
        <div class="unit-inner unit-foot-inner">
            <div class="misc vcard">
                <div class="about">
                    <h4>
                        <a href="/blog/other/about/">关于</a>
                        
                    </h4>
                </div>
                <div class="social-links">
                    
                        <a class="ico-gmail" href="mailto:1460300366@qq.com" rel="me" target="_blank" title="email"></a>
                    
                    <a class="ico-rss" href="/feed.xml" rel="me" target="_blank" title="feed"></a>
                    
                        
                    
                        
                            <a class="ico-github" href="https://github.com/petterobam" rel="me" target="_blank" title="github"></a>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                </div>
            </div>
        </div>
    </div>
    <a href="#" class="internal back-to-top">返回顶部</a>
</footer>


    </div>
    <script>
$(document).ready(function () {
    var offset = 50,
        duration = 500,
        width = 960;
    var dirOldTop = 37;
    $(window).scroll(function () {
    	var scrollTop = $(this).scrollTop();
        if (scrollTop > width) {
            if (scrollTop > offset) {
                $('footer').css('top', '20px');
                $('footer .back-to-top').fadeIn(duration);
            } else {
                $('footer').css('top', 'auto');
                $('footer .back-to-top').fadeOut(duration);
            }
        }
        var directory = $("#directory");
        if(null != directory && directory.length > 0){
        	var top;
        	if(scrollTop > dirOldTop){
        		top = (scrollTop - dirOldTop) + "px";
        	}else{
        		top = dirOldTop + "px";
        	}
        	directory.css("top",top);
        }
    });
    $(window).resize(function () {
        if ($(window).width() < width) {
            $('footer').css('top', 'auto');
            $('footer .back-to-top').fadeOut(duration);
        }
        if ($(window).width() >= width && $(this).scrollTop() > offset) {
            $('footer').css('top', '20px');
            $('footer .back-to-top').fadeIn(duration);
        }
    });

    $('footer .back-to-top, .gotop').on('click', function (event) {
        event.preventDefault();
        $('html, body').animate({
            scrollTop: 0
        }, duration);
        return false;
    });

    $('.show-hidden').on('click', function () {
        $(this).parent().next().toggleClass("hidden");
        $(this).toggleClass("hidden");
    });
});
</script>

<!-- Google Analytics Event tracking -->


<!-- Show menu overlay + Jekyll Simple Search option -->
<script src="/assets/javascripts/jekyll-search.jquery.js"></script>
<script>
$(document).ready(function () {
    $('.search-field').simpleJekyllSearch({
      jsonFile: '/search.json',
      template: '<li><a href="{url}">{title} <span class="entry-date"><time datetime="{date}">{shortdate}</time></span></a></li>',
      searchResults: '.search-wrapper .results',
      searchResultsTitle: '<h4>搜索结果</h4>',
      noResults: '<p>啊哈<br/><small>什么也没找到 :(</small></p>'
    });
});

(function ($, window, undefined) {
    var closeOverlay = function () {
        $('.nav-wrapper, .search-wrapper').removeAttr('style');
        $(".nav-form, .search-form").removeClass('active');
        $("body").removeClass('nav-overlay search-overlay');
    };

    $('.nav-global .btn-init-live2dgirl').on('click', function () {
        initLive2dGirl();
    });

    $('.nav-global .btn-search').on('click', function () {
        $('.search-wrapper').css({display: "block"});
        $(".search-form").addClass('active');
        $(".search-form").find('input').focus();
        $("body").addClass('search-overlay');
    });

    $('.nav-global .btn-menu').on('click', function () {
        $('.nav-wrapper').css({display: "block"});
        $(".nav-form").addClass('active');
        $(".nav-form .search-field").prop('disabled', true);
        $("body").addClass('nav-overlay');
    });

    $('.nav-wrapper .btn-close, .search-wrapper .btn-close').on('click', function () {
        closeOverlay();
    });

    $(document).on('keyup', function (e) {
        if (e.keyCode === 27) {
            closeOverlay();
        }
    });
})(jQuery, window);
</script>

<script src='//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.js'></script>
<script src='//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-buttons.min.js'></script>
<script src="/assets/javascripts/unveil/jquery.unveil.min.js"></script>

<script>
    window.jQuery.fancybox || document.write('<script src="/assets/javascripts/fancybox/jquery.fancybox.pack.js?v=2.1.4"><\/script>')
    window.jQuery.fancybox.helpers.buttons || document.write('<script src="/assets/javascripts/fancybox/helpers/jquery.fancybox-buttons.js?v=1.0.5"><\/script>')
</script>

<script>
    $("head").append('<link rel="stylesheet" href="/assets/javascripts/fancybox/jquery.fancybox.css?v=2.1.4" type="text/css" />');
    $("head").append('<link rel="stylesheet" href="/assets/javascripts/fancybox/helpers/jquery.fancybox-buttons.css?v=1.0.5" type="text/css" />');
    $(".post-image").fancybox({
        prevEffect: 'none',
        nextEffect: 'none',
        closeBtn: true,
        helpers: {
            title: {
                type: 'float'
            }
        }
    });
    $(document).ready(function () {
        $(".post-image > img").unveil(450);
        $(".nav-global a[label='learn']").css("background-color", "orange")
    });
</script>

<!-- LaTeX 语法支持 -->
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

<!-- 动态隐藏 post 的 js -->
<style type="text/css">
  ul.post-list li.post2hide {
    display: none;
  }
</style>

<script text="text/javascript">
  $(document).ready(function() {
    // 获取URL参数
    const urlParams = new URLSearchParams(window.location.search);
    // 检查是否有action参数，并且其值为all
    if(urlParams.get('action') === 'all' || '' === 'all') {
      // 找到所有不可见的<li>元素并将其显示出来
      $('li.post2hide').show();
    }
  });
</script>
<!-- 折叠 post 列表 的 js -->


<!-- 图片点击预览 -->
<div id="imgEnlargeDiv" style="display: none; text-align: center;position: fixed;z-index: 1000;top: 0;left: 0;
    width: 100%;height: 100%;background-color: rgba(255,255,255,.9);overflow: hidden;">
    <img id="bigimg-random-12312" style="height: auto;width: 90%;
    position: absolute;margin:auto;top:0;bottom:0;left: 0;right: 0;" title="单击关闭图层" src="" />
</div>
<script type="text/javascript">
    // 图片放大  
    $(function () {
        $("#imgEnlargeDiv").click(function () {
            // 再次点击淡出消失弹出层    
            $(this).fadeOut("fast");
        });
        imgEnlarge();
    });

    function imgShow(outerdiv, bigimg, _this) {
        var src = _this.attr("src");// 获取当前点击的pimg元素中的src属性    
        $(bigimg).attr("src", src);// 设置#bigimg元素的src属性    
        $(outerdiv).fadeIn("fast");  // 图片放大的div快速淡入显示层
        var imgWidth = $(bigimg).width();
        var imgHeight = $(bigimg).height();
        if (imgHeight > imgWidth) {
            $(bigimg).css("height", "90%").css("width", "auto");
        } else {
            $(bigimg).css("height", "auto").css("width", "90%");
        }
    }

    var img2ShowExit = true;
    function imgEnlarge() {
        $(".entry-content img").mouseover(function () {
            $(this).css("cursor", "pointer");//鼠标移动到图片，鼠标箭头变为手势
        });
        $(".entry-content img").click(function () {
            var _this = $(this);// 将当前的pimg元素作为_this传入函数    
            imgShow("#imgEnlargeDiv", "#bigimg-random-12312", _this);
        });
    }
</script>
<!-- gist 引用折叠 -->
<script type="text/javascript">
$(function () {
    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        // 是移动设备
        $(".gist-file").click(function() {
            if ($(this).attr("pack-up") == "1") {
                $(this).find(".gist-data").css({
                    "overflow": "auto",
                    "height": "auto",
                    "border-bottom": "1px solid #ddd"
                });
                $(this).find(".gist-meta span").html('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ↑↑ 单击收起 ↑↑ &nbsp;&nbsp;&nbsp;');
                $(this).attr("pack-up", "0");
            } else {
                $(this).find(".gist-data").css({
                    "overflow": "hidden",
                    "height": "75px",
                    "border-bottom": "3px solid red"
                });
                $(this).find(".gist-meta span").html('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ↑↑ 单击展开 ↑↑ &nbsp;&nbsp;&nbsp;');
                $(this).attr("pack-up", "1");
            }
        });
      } else {
        $(".gist-file").dblclick(function() {
            if ($(this).attr("pack-up") == "1") {
                $(this).find(".gist-data").css({
                    "overflow": "auto",
                    "height": "auto",
                    "border-bottom": "1px solid #ddd"
                });
                $(this).find(".gist-meta span").html('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ↑↑ 双击收起 ↑↑ &nbsp;&nbsp;&nbsp;');
                $(this).attr("pack-up", "0");
            } else {
                $(this).find(".gist-data").css({
                    "overflow": "hidden",
                    "height": "75px",
                    "border-bottom": "3px solid red"
                });
                $(this).find(".gist-meta span").html('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ↑↑ 双击展开 ↑↑ &nbsp;&nbsp;&nbsp;');
                $(this).attr("pack-up", "1");
            }
        });
    }

    $(".gist-file").find(".gist-data").css({
        "overflow": "hidden",
        "height": "75px",
        "border-bottom": "3px solid red"
    });
    $(".gist-file").attr("pack-up", "1");
    $(".gist-file").find(".gist-data").css({"cursor":"pointer"});
    $(".gist-file").find(".gist-meta").append('<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ↑↑ 双击展开 ↑↑</span>');
});
</script>


<!-- live2dgirl加载 -->

<link rel="stylesheet" type="text/css" href="/assets/javascripts/live2dgirl/waifu.css"/>
<!-- <script src="/assets/javascripts/live2dgirl/jquery.min.js"></script> -->
<div class="waifu">
    <div class="waifu-tips"></div>
    <canvas id="live2d" width="280" height="250" class="live2d"></canvas>
    <div class="waifu-tool">
        <span class="fui-home"></span>
        <span class="fui-chat"></span>
        <span class="fui-eye"></span>
        <span class="fui-user"></span>
        <span class="fui-photo"></span>
        <span class="fui-info-circle"></span>
        <span class="fui-cross"></span>
    </div>
</div>
<script sync src="/assets/javascripts/live2dgirl/waifu-tips.js"></script>
<script sync src="/assets/javascripts/live2dgirl/live2d.js"></script>
<script type="text/javascript">
function initLive2dGirl() {
    $(".waifu").css('display', 'block');
    initModel("/assets/javascripts/live2dgirl/");
}
</script>


    
    
    <script src="/assets/javascripts/prism.js"></script>
</body>

</html>

