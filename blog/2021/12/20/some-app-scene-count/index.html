<!DOCTYPE html>

<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="zh">
<!--<![endif]-->

<head>
    <meta charset="utf-8">
<!--[if IE]><meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'><![endif]-->
<meta name="viewport" content="width=device-width,initial-scale=1">

<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>【专题】应用计数案例归纳和总结 | 欧阳Boy_Petter&#39;s Blog</title>
<meta name="generator" content="Jekyll v3.5.2" />
<meta property="og:title" content="【专题】应用计数案例归纳和总结" />
<meta name="author" content="欧阳Boy_Petter" />
<meta property="og:locale" content="zh" />
<meta name="description" content="计数案例归纳和总结" />
<meta property="og:description" content="计数案例归纳和总结" />
<meta property="og:site_name" content="欧阳Boy_Petter&#39;s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-12-20T00:00:00+00:00" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"欧阳Boy_Petter"},"description":"计数案例归纳和总结","@type":"BlogPosting","url":"/blog/2021/12/20/some-app-scene-count/","headline":"【专题】应用计数案例归纳和总结","dateModified":"2021-12-20T00:00:00+00:00","datePublished":"2021-12-20T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"/blog/2021/12/20/some-app-scene-count/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<meta name="keywords" content="计数,高并发,通用性" />





<link type="application/atom+xml" rel="alternate" href="/feed.xml" title="欧阳Boy_Petter's Blog" />
    <link href='/assets/stylesheets/blog.css' rel="stylesheet" type="text/css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
<script>window.Modernizr || document.write('<script src="/assets/javascripts/modernizr-2.8.3.min.js"><\/script>')</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>
    window.jQuery || document.write('<script src="/assets/javascripts/jquery-3.2.1.min.js"><\/script>')
</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"></script>
<script>
    window.Pace || document.write('<script src="/assets/javascripts/pace.min.js"><\/script>')
</script>


</head>

<body>
    <!--[if IE]>
    <p class="site-notice">您正在使用一个过时的网页浏览器。请<a href="http://browsehappy.com/" target="_blank">升级您的浏览器</a>或<a href="http://www.google.com/chromeframe/?redirect=true" target="_blank">开启 Google Chrome Frame</a> 来提高用户体验。</p>
<![endif]-->
<noscript>
    <p class="site-notice">本网站需要 JavaScript。请查阅指南来<a href="http://www.enable-javascript.com/" target="_blank">给您的浏览器开启 JavaScript 功能</a>。</p>
</noscript>

    <div class="nav-wrapper overlay-wrapper">
    <div class="nav-form overlay-form">
        <span class="overlay-header menu">菜单</span>
        <a class="btn-close">关闭</a>
        <div class="results">
            <ul>
                <li><a href="/blog/">文章</a></li>
                <li><a href="/blog/categories/">分类</a></li>
                <li><a href="/blog/tags/">标签</a></li>

                <li><a href="/blog/reader/">读书</a></li>
                <li><a href="/blog/movie/">影音</a></li>
                <li><a href="/blog/book+movie/">书&影</a></li>

                <li><a href="/blog/learner/">笔记</a></li>
                <li><a href="/blog/life/">动态</a></li>
                <li><a href="/blog/letter/">信</a></li>
                <li><a href="/blog/song/">歌</a></li>
                <li><a href="/blog/story/">文</a></li>
                <li><a href="/blog/plan/">业</a></li>
                <li><a href="/blog/family/">家</a></li>
                <li><a href="/blog/other/">杂</a></li>
                <li><a href="/">关于</a></li>
            </ul>
        </div>
    </div>
</div>

<div class="search-wrapper overlay-wrapper">
    <div class="search-form overlay-form">
        <input type="text" class="overlay-header search-field" placeholder="搜索...">
        <a class="btn-close">关闭</a>
        <ul class="results"></ul>
    </div>
</div>


    <div id="page" class="hentry">
        <header class="the-header">
    <div class="unit-head">
        <div class="unit-inner unit-head-inner">
            <nav class="nav-global">
                <ul>
                    <li class="logo">
                        <button class="btn-menu" title="菜单"></button>
                        <a href="/blog/">欧阳Boy_Petter's Blog</a>
                        <!--[if !IE]> -->
                        <button class="btn-search" title="搜索"></button>
                        <!-- <![endif]-->
                    </li>
                    <li class="nav-link"><a label="article" title="文章" href="/blog/">文章</a></li>

                    <!-- <li class="nav-link"><a label="book" title="读书" href="/blog/reader/">读书</a></li> -->
                    <!-- <li class="nav-link"><a label="movie" title="影音" href="/blog/movie/">影音</a></li> -->
                    <li class="nav-link"><a label="book+movie" title="书&影" href="/blog/book+movie/">书&影</a></li>
                    
                    <li class="nav-link"><a label="learn" title="笔记" href="/blog/learner/">笔记</a></li>
                    <li class="nav-link"><a label="life" title="动态" href="/blog/life/">动态</a></li>
                    <li class="nav-link"><a label="letter" title="信" href="/blog/letter/">信</a></li>
                    <li class="nav-link"><a label="song" title="歌" href="/blog/song/">歌</a></li>
                    <li class="nav-link"><a label="story" title="文" href="/blog/story/">文</a></li>
                    <li class="nav-link"><a label="plan" title="业" href="/blog/plan/">业</a></li>
                    <li class="nav-link"><a label="family" title="家" href="/blog/family/">家</a></li>
                    <li class="nav-link"><a label="other" title="杂" href="/blog/other/">杂</a></li>
                    <!--[if !IE]> -->
                    <li class="nav-link"><a title="搜索" class="btn-search" href="#">搜索</a></li>
                    <!-- <![endif]-->
                </ul>
            </nav>
        </div>
    </div>
</header>


        <div class="body animated fadeInDown" role="main">
            <div class="unit-body">
                <div class="unit-inner unit-body-inner">
                    <div class="entry-content">
                        <article id="article-content" class="unit-article layout-post">
    <div class="unit-inner unit-article-inner">
        <div itemscope itemtype="http://schema.org/Article" class="content">
            <header>
                <div class="unit-head">
                    <div class="unit-inner unit-head-inner">
                        <h1 class="entry-title" itemprop="name">【专题】应用计数案例归纳和总结</h1>
                    </div>
                </div>
            </header>
            <div class="bd article-content">
                <div class="entry-content">
                    <div class="meta">
                        <p class="date-publish">
                            发表信息:
                            <time itemprop="datePublished" class="date-pub updated"
                                title="2021-12-20T00:00:00+00:00" datetime="2021-12-20T00:00:00+00:00">December 20, 2021 </time>
                            by
                            <a class="author" href="/" rel="author" title="显示作者">
                                <span itemprop="author" itemscope itemtype="http://schema.org/Person">
                                    <span itemprop="name">欧阳Boy_Petter</span>
                                </span>
                            </a>
                            
                                <a class="license-icon" rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" title="显示许可证">
                                    <img alt="Creative Commons Licence" style="border-width:0" src="/assets/images/theme/cc-by-sa.png"  height="16" width="80"/>
                                </a>
                            
                            
                        </p>
                        


<p style="margin-top: 0px;margin-bottom: 0px;">
  字数：557 字，&nbsp;预计阅读时间：5 分钟
</p>
                        
                        <ul class="list-category list-linear">
                            <li class="list-head">分类: </li>
                             
     
        <li>
            <a href="/blog/categories/#总结" title="总结">
            总结 <span>9</span></a>
        </li>
     
        <li>
            <a href="/blog/categories/#整理" title="整理">
            整理 <span>22</span></a>
        </li>
    



                        </ul>
                        
                        
                        <ul class="list-tag list-linear">
                            <li class="list-head">标签: </li>
                             
    
        
        <li>
            <a href="/blog/tags/#计数" title="计数">计数 <span>1</span></a>
        </li>
    
        
        <li>
            <a href="/blog/tags/#通用性" title="通用性">通用性 <span>1</span></a>
        </li>
    
        
        <li>
            <a href="/blog/tags/#高并发" title="高并发">高并发 <span>1</span></a>
        </li>
    




                        </ul>
                        
                    </div>
                    <div id="articleBody" itemprop="articleBody">
                        <div class="highlighter-rouge"><pre class="highlight"><code>这是一次公司内的分享，个人感觉普适性应该比较高，这里分享下~
</code></pre>
</div>

<h2 id="heading-需要讨论的点">需要讨论的点</h2>

<blockquote>
  <h3 id="heading-谈到计数我们会讨论什么">谈到计数，我们会讨论什么？</h3>
</blockquote>

<ol>
  <li>高并发</li>
  <li>实时性</li>
  <li>准确性</li>
  <li>真实性</li>
  <li>一次性</li>
  <li>有效性</li>
  <li>复用性</li>
</ol>

<blockquote>
  <h3 id="heading-我们需要从一些点来切入">我们需要从一些点来切入</h3>
</blockquote>

<ol>
  <li>高低并发与否</li>
  <li>是否允许轻微误差</li>
  <li>最小业务维度内是否可重复</li>
  <li>是否双向计数</li>
  <li>虚拟计数</li>
  <li>是否一次性可消除</li>
  <li>是否受历史累计影响</li>
  <li>如何复用计数能力</li>
</ol>

<h2 id="heading-示例展开以点带面">示例展开，以点带面</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>个人以在云音乐接触或了解过的一些计数场景，这里抛转引玉，和大家一起讨论一下。
</code></pre>
</div>

<p><img src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/12217016552/1970/1c89/cb21/58bfa00e0200dd218fb2ede41b9af6f3.png" alt="播放数雷达图" /></p>

<h3 id="heading-播放">播放</h3>

<blockquote>
  <p>特征：高并发、可重复、单向计数、实时级</p>
</blockquote>

<p><img src="https://p5.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/12171217718/20f7/9277/5fc1/27d973972604186c613847a38d7beff4.png" alt="播放数雷达图" /></p>

<blockquote>
  <p>解决方向：聚合处理、批量处理</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>不同数据层次或存储介质，流量承受能力不同。
网关 - 消息 - 缓存 - 数据库

播放本是一个可能发生高并发的事件，解决这类计数问题主要两个方向：
1、加快单元事件处理速度 ———— 拆分处理（一件事拆成多个步骤）
2、减少底层存储介质访问频率 ———— 聚合处理（多个事结果汇总）
</code></pre>
</div>

<blockquote>
  <p>云音乐内部提供了类似能力的成熟工具</p>
</blockquote>

<p>略。</p>

<blockquote>
  <p>播放日志的常规处理流程或者步骤</p>
</blockquote>

<p>由于播放行为的可重复性和操作简单性，且具有极大的并发性，目前成熟的做法基本是：</p>
<ol>
  <li>记录不入库，或仅日志记录（播放日志）或存入搜索索引平台（比如 ES）</li>
  <li>计数二次分发（消息），且通过缓存层聚合，定时 hash 入库。</li>
</ol>

<div class="highlighter-rouge"><pre class="highlight"><code>1、搜索索引平台，是成熟的大数搜索体系。比如日志的 ELK，一些公司也会自研搜索平台。
2、消息二次分发，可以让并发在一定范围更加均匀，抚平高并发突刺；消息也可以实现一定的可靠性。
3、缓存层聚合，可以极大减少数据库访问，提升存储性能；由于缓存层可靠性不够稳定，最好实现冷备或备用缓存。
4、hash 入库，服务器（消费者）通常通过计数表均衡字段选择消费，保证单台服务器处理的计数数据落到同一个数据库。
</code></pre>
</div>

<p><img src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/12231503298/2a35/2bfc/f5a6/af66ee34d5f9b6ee9e72be3ea41cb779.png" alt="播放日志处理流程" /></p>

<blockquote>
  <p>扩展：去噪</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>同一时刻，同一用户，同一视频，同一机器，产生了大量播放行为。（重复日志）
同一时间，同一用户，同一视频，不同机器，产生了大量播放行为。（反作弊）
</code></pre>
</div>

<p><img src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/12199302334/5b5c/4a66/3c52/78aaa220649c3b677ab2631485a12b46.png" alt="app-play-count-duplicate-deal.png" /></p>

<blockquote>
  <p>真实计数和展示计数</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>业务初期由于流量不足，为了快速增长或吸引用户，通常都会做特殊的展示计数逻辑，即 Mock 计数。
新人为了扶持流量或 Buffer 加持也可能会采用 Mock 计数来增长展示计数。
</code></pre>
</div>

<p>一般 Mock 计数有如下类似的模式：</p>
<ol>
  <li>展示计数给个随机初始计数，或算法定时计算随机给予展示计数一个增量扶持计数</li>
  <li>增量展示计数=增量真实计数 * 因子</li>
</ol>

<p>不言而喻，【增量展示计数=增量真实计数 * 因子】更自然，因此很多文章做在因子上：</p>
<ol>
  <li>因子=随机可选值</li>
  <li>因子=fn(时间变量)</li>
  <li>因子=fn(真实计数总量，时间变量)</li>
</ol>

<p>由于，【增量真实计数】在固定时间窗内总数有不确定性，因此有一定的自然度，所以以上策略基本没有太大差异。</p>

<p>PS：不过随着时间的增长，因子的作用会越来越小，其实可以使用对数函数，让因子结果显得更自然。</p>

<h3 id="heading-点赞收藏数">点赞、收藏数</h3>

<blockquote>
  <p>特征：实时级、双向计数、不可重复、允许轻微误差</p>
</blockquote>

<p><img src="https://p5.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/12183084548/7964/b354/5f25/ab34d022bf5d6cee9290e29ee2eb536d.png" alt="点赞收藏数雷达图" /></p>

<blockquote>
  <p>用户行为的触发难度决定表现模式</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>1、某种用户行为触发越简单，其越容易发生，产生的流量越大，同样并发级也越高
2、某种用户行为可重复性越高，实现难度越低，越有可能产生大流量，同样并发级也越高
3、某种用户行为产生的利益越高，越有可能被作弊，越有可能产生大流量，同样并发级也越高
</code></pre>
</div>

<p><img src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/12182515918/0d92/6fcd/c6f3/3a31cc07a12abbc67dcd155471c32332.png" alt="用户行为触发难度-并发级" /></p>

<blockquote>
  <p>用户维度通用计数存储结构</p>
</blockquote>

<p><img src="https://p5.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/12183563480/72aa/3ee4/f12c/979af5e30002bea50eda3a3723fbaba9.png" alt="用户维度行为记录通用存储" /></p>

<p><img src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/12183563481/2f34/f4da/8ff7/9d44118ef7e423c34b7e71158b0ad6f3.png" alt="用户维度行为计数通用存储" /></p>

<blockquote>
  <p>用户互动行为通用计数能力复用</p>
</blockquote>

<p><img src="https://p5.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/12183946784/5f61/7563/a509/97eb9f8856173c781983180484f977ca.png" alt="用户互动行为通用能力复用" /></p>

<div class="highlighter-rouge"><pre class="highlight"><code>1、存储结构复用
2、Dao层逻辑复用（动态表）
3、消息逻辑复用（动态消息）
4、前后流程控制复用（入参控制）
    1）同时记录和计数
    2）先记录，异步计数
</code></pre>
</div>

<p>目前复用此能力的服务有：</p>
<ol>
  <li>SDK 方向（本地化）： 用户行为关系业务领域服务SDK</li>
  <li>API/RPC 方向（服务化）： 互动中台接入文档</li>
</ol>

<h3 id="heading-评论数">评论数</h3>

<blockquote>
  <p>特征：即时级、可重复、不允许误差、双向计数</p>
</blockquote>

<p><img src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/12171219513/f235/ce52/22fa/7a6f6e3fbfe6e42bdeb0e034dfecf948.png" alt="评论数雷达图" /></p>

<blockquote>
  <p>评论不仅是一种交互行为，还是一种资源</p>
</blockquote>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="err">评论虽然是作为一种附属资源，但却拥有很多资源自身的独立业务。</span>
<span class="err">除了普通的计数，还有其他相关业务计数。</span>
<span class="c1">------------------------------------------------------------</span>
<span class="err">由于评论是一种计数，所见即所得，评论数对应会展示对应数量的评论。</span>
<span class="c1">------------------------------------------------------------</span>
<span class="err">由于评论还带状态，我们初略分为：所有人可见、仅自见可见</span>
<span class="err">故，某资源评论数</span><span class="o">=</span><span class="err">所有人可见评论数</span><span class="o">+</span><span class="err">仅自见可见评论数</span>

<span class="err">评论计数表结构：略</span>
</code></pre>
</div>

<h3 id="heading-分享数">分享数</h3>

<blockquote>
  <p>特征：实时级一般、可重复、允许误差、单向计数</p>
</blockquote>

<p><img src="https://p5.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/12171218629/4133/7554/7a90/111a59d6ee8318dcad323813785d8624.png" alt="分享数雷达图" /></p>

<blockquote>
  <p>普通却不可少，有潜力却没机会</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>分享是产品借助流量传播的重要渠道，是所有互动里面必不可少的环节。
-----------------------------------------------
我们来看下分享这个交互的表面优势：
1、人人都爱分享，这个在社交里面是刚需
2、分享可以新增流量引入，增加曝光，造成更多的分享
3、分享可以重复，重复可以造成更多的流量，站内、微信、微博...
-----------------------------------------------
但是，分享没有优势基因：
1、分享是跨 APP 的，难以打破这种断层般体验感
2、分享比较隐私，操作会打断体验，触发成本比较高
3、分享不能做为激励指标，由于是跨 APP 操作，很难确定有效性
    PS：如果作为激励指标，由于它的重复性和跨APP操作，无法感知作弊，很容易被刷。
</code></pre>
</div>

<h3 id="heading-我的作品数">我的作品数</h3>

<blockquote>
  <p>特征：即时级、双向计数、不允许误差、多状态</p>
</blockquote>

<p><img src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/12171220115/9a97/94a5/5bd4/43243e7967b5dff197694f876746ac37.png" alt="作品数雷达图" /></p>

<blockquote>
  <p>贯穿整个产品的生命周期</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>作品数记录着作品的生命周期指标，影响它变化的因素非常多样：
1、从作品发布后经历 反垃圾、人工审核 到确定可见性后
2、后续还会碰到用户主动删除
3、用户主动修改可见性
4、政策或突发事件导致重新审核导致下架
5、其他影响作品状态的因素

内容为王的当前，创作者体验是产品出位的重点：
1、作品数对于创作者是一种敏感性数据，如果出现误差会引起负反馈。
2、作品数对于客态访问者，如果出现不一致会引起产品信任危机。
3、作品数对于统计数据，如果作为激励或指标排名，会引起客诉。
</code></pre>
</div>

<blockquote>
  <p>云音乐产品的优势</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>云音乐相比于微信或微博，能够做出层次更加丰富的社交体验。
想要做出更丰富的社交体验，则需要做出更多层次的隐私权限。

Mlog 产品计数层次
1、NomalStatusCount（所有人可见）
2、OnlySelfSeeCount（仅自见，反垃圾导致）
3、UserDeleteCount（自己删除）

动态产品的计数层次
1、所有人可见
2、好友可见
3、仅粉丝可见
4、仅圈子可见
3、仅自见可见
</code></pre>
</div>

<blockquote>
  <p>多层次的隐私权限结构设计</p>
</blockquote>

<p><img src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/12197038223/82f7/6204/a806/369a0b990bc2e0704c76ed29e9374cc9.png" alt="作品计数表通用结构设计" /></p>

<h3 id="heading-话题参与人数">话题参与人数</h3>

<blockquote>
  <p>特征：实时性低、单向计数、允许误差</p>
</blockquote>

<p><img src="https://p5.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/12171218632/1eaf/6d53/964b/84768410c8ea8e4a8be41f33df5693e8.png" alt="话题参与人数雷达图" /></p>

<blockquote>
  <p>同样是作品产生的计数，却地位不同</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>某用户在某个话题下发布了作品，则认为该用户参与了此话题。
同样是作品发布产生的计数，其准确性、实时性却并不显得和作品数这般重要。
1、参与人数是单向计数，只能单向积累，作品状态变化不会影响计数。
2、话题参与人数并不是一个敏感指标，关注的用户不多。
3、话题参与人数只是一个参考数据，不能关键性影响话题本身的热度。
</code></pre>
</div>

<h3 id="heading-消息数红点计数">消息数、红点计数</h3>

<blockquote>
  <p>特征：即时级、一次性、单向计数</p>
</blockquote>

<p><img src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/12171219517/a54a/1fc1/f875/779bec6221ef8afa0ab67493b45d9182.png" alt="消息&amp;红点计数雷达图" /></p>

<blockquote>
  <p>一次性特征的计数业务</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>红点或数字气泡或者特殊引导属于一次性计数业务。
目标：引流、引导业务
特征：只要用户曝光过，就清零。
-----------------------------------------
计数仅单纯累加模式，清除用拉模式直接归零。
</code></pre>
</div>

<blockquote>
  <p>消息私信数（半一次性）</p>
</blockquote>

<p><img src="https://p5.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/12198923227/ab6b/7219/d2c7/00545536041beb02c39ca22d699bcabb.png" alt="私信业务计数流程" /></p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="mi">1</span><span class="err">、</span><span class="n">One</span> <span class="k">to</span> <span class="n">One</span> <span class="err">的私信计数主表（一次性特征）</span>
<span class="err">略</span>

<span class="mi">2</span><span class="err">、用户私信总计数表（普通双向计数表，用户维度低并发）</span>
<span class="err">略</span>
</code></pre>
</div>

<blockquote>
  <p>动态红点计数（一次性）</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>用户维度的持久化缓存（redis）—— event_redis_count_key
1、业务 1： 动态流推荐数据，单纯累加 event_redis_count_key 缓存计数
2、业务 2： 共鸣匹配推荐数据，单纯累加 event_redis_count_key 缓存计数
3、业务 3： 音乐人新歌提醒，单纯累加 event_redis_count_key 缓存计数
4、业务 n： xxx，单纯累加 event_redis_count_key 缓存计数
</code></pre>
</div>

<p><img src="https://p5.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/12199166851/fc90/0fdc/e5aa/6f43e3e0032fc8b6737f6e04754b0b77.png" alt="动态红点计数流程" /></p>

<h3 id="heading-热榜点击数">热榜点击数</h3>

<blockquote>
  <p>特征：实时级、高并发、单向计数、实时排序</p>
</blockquote>

<p><img src="https://p5.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/12171220113/9f1e/ec13/2a4e/c2b68753555f5098f59ed4937f85e61c.png" alt="热榜点击数雷达图" /></p>

<blockquote>
  <p>时间窗口区计数缓存</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>热度计数最重要的就是规避历史高热度的累积资源，涉及到计数更新的问题
1、如何淘汰现在已经不热了的历史热度资源（范围计数 -&gt; 时间窗口计数）
2、如何做到快速排序（维护时间窗口计数排序列表）
3、如何做到时间窗计数的连贯性（分片粒度+分段窗口）
</code></pre>
</div>

<p><img src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/12222336930/85c5/c694/1c17/0fdb01b1cb90713139f580010f5b17a4.png" alt="时间窗计数流程" /></p>

<blockquote>
  <p>异化计数： 话题热度</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>若将话题点击数改成话题热度，那么只需要一个增量的公式。
将点击数累积转化成热度值累积，则变成实时话题热度排行榜的需求。
而上述就是一种异化计数。
热度公式可以类似于： hotScore = clickCount * (100 / totalCount) + x
</code></pre>
</div>

<h3 id="heading-听歌记录数">听歌记录数</h3>

<blockquote>
  <p>高并发、实时性低、可重复、允许误差</p>
</blockquote>

<p><img src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/12217037530/c599/962f/3764/79c926db7da565968c0196cef7701172.png" alt="听歌总时长雷达图" /></p>

<blockquote>
  <p>BI 处理或缓存延迟处理</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>时间和准确性要求低的情况，基本可以延迟甚至离线处理。
</code></pre>
</div>

<p><img src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/12217858178/fbf6/6395/0795/09f73099958ed1e6f14d4f7201199977.png" alt="用户听歌排行计数流程" /></p>

<h2 id="heading-思考">思考</h2>

<blockquote>
  <p>思考与应用</p>
</blockquote>

<p>这里有几个现想的需求，大家可以思考下，可以看下他们分别归属于哪一类：</p>
<ol>
  <li>动态需要开发专题，专题有订阅的功能，订阅这块的计数如何设计？</li>
  <li>云圈广场需要在云圈龙珠上展示每个圈子圈内所有未读的消息数，这块需要如何设计？</li>
  <li>云音乐要开发听歌沉浸时间的需求，需要统计听歌时长，并且出用户维度月报、周报听歌时长分析报告，如何设计？</li>
  <li>云音乐需要开发实时活跃歌曲在线听榜单，如何设计？</li>
</ol>

<h2 id="heading-结语">结语</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>什么是计数？

计数一般是针对资源附加属性，而资源涉及到方方面面，
它可以是用户产生的内容（我的作品数），
也可以是内容的附加描述（视频的播放数、点赞数），
也可以是一种产品描述（我的听歌总数），
甚至可以是一种异化的计数（我的听歌时长），
抑或是描述资源间的关系指标（我的好友数、关注我的人数）

我们发现，应用内的一切对象或元素（meta）都可以成为一种资源。
PS：用户是不是一种资源？ ———— 是的，用户也是一种资源，是一种特殊的资源。

这里，我们将计数异化定义下：一切累积效应的数字，可以认为是某种资源的计数。
它承担着重要的故事讲述能力。
首先，它显而易见的向用户传达，这个数字不是一蹴而就的，是慢慢积累的。
其次，它告诉用户：
  你这个人火不火，看你的粉丝数。
  你这个作品好不好，看你的播放数、点赞数。
  你这个产品优不优秀，看用户总数、使用时长、总活跃度。
  你这个应用热不热，看下载数、讨论热度。

我们做一个功能模块或产品内容，若给用户传达的累积量化指标很少。
用户不会理解这个产品的故事，他们就不会用时间去买单。

我们可以认为，计数是荣誉、成就感、归属感、标杆、方向、品牌图腾。
</code></pre>
</div>

<blockquote>
  <p>用户心智</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>当用户开始关注这些数据，被这些数据引导行为，并开始为这些数据买单时；随之而来的就是用户心智。
</code></pre>
</div>

                    </div>
                </div>
            </div>
            <footer class="unit-foot">
                <div class="unit-inner unit-foot-inner">
                    <div class="post-buttons">
                        <a class="internal gotop" href="#page" title="返回顶部">返回顶部</a>
                        
                    </div>
                    <nav class="pagination">
                        
                            <a class="internal" rel="prev" href="/blog/2021/05/24/patent/" title="上一篇 '【专利】视频流消费区块超链分析与应用'"> ← 【专利】视频流消费区块超链分析与应用</a>
                        
                        
                            <a class="internal" rel="next" href="/blog/2021/12/27/java-like-tensor-flow-to-run/" title="下一篇 '仿TensorFlow懒执行编程和注解自编排'">仿TensorFlow懒执行编程和注解自编排 → </a>
                        
                    </nav>
                </div>
            </footer>
        </div>
    </div>
</article>
<!-- 评论组件 -->
<!-- 聚合所有评论组件 -->

<div class="misc-content">

<!-- emaction -->

<div style="margin-top: 10px;color: coral;border-top: 1px solid;border-bottom: 1px solid;">
<div style="float:left;">邀请标记你的阅读体验😉 ｜ → &nbsp;</div>
<emoji-reaction></emoji-reaction>
<div style="clear:both;"></div>
</div>
<script type="module" src="https://cdn.jsdelivr.net/gh/emaction/frontend.dist@1.0.7/bundle.js"></script>

<script type="text/javascript">
    $(document).ready(function() {
        $($("emoji-reaction")[0].shadowRoot).find("div.container").css("align-items","center");
    });
</script>

<!-- gitment -->

<!-- utterances -->

<script src="https://utteranc.es/client.js"
    repo="petterobam/blog"
    
    issue-term="pathname"
    
    theme=""
    crossorigin="anonymous"
    async></script>


</div>
<!-- 悬浮目录组件 -->


<style type="text/css">
.directory-content{font-size:15px;line-height:28px;position:relative;z-index:20;max-width:1000px;margin-right:auto!important;margin-left:auto!important;text-align:right}
.directory-content.initial{opacity:0}
.directory-content.pinned{opacity:1}
.directory-content.unpinned{opacity:1}
.directory-content.headroom--top{opacity:0}
.directory-content.headroom--not-top{-webkit-transition:opacity .5s ease-in-out;transition:opacity .5s ease-in-out;opacity:1}
#directory{position:fixed;z-index:20;top:37px;right:45px;display:inline-block;text-align:left;background-color:#edeff2;padding:10px 20px;border-radius:3px;filter: alpha(Opacity=90);-moz-opacity: 0.9;opacity: 0.9;}
#directory li,#directory ul{margin:0;padding-left:0;list-style:none}
#directory>ul{position:relative;border-left:1px solid #ddd}
#directory>ul>li::before{position:relative;top:0;left:-4px;display:inline-block;width:7px;height:7px;content:'';border-radius:50%;background-color:#eb5055}
#directory ul li a{display:inline-table;margin-left:5px;white-space:nowrap}
#directory ul li ul li a{margin-left:20px;white-space:nowrap;color:#5f5f5f}
#directory ul li ul li ul li a{margin-left:30px;color:#5f5f5f}
#directory a:hover{color:#eb5055}
@media (max-width: 768px) {
    #directory p,ul {
        display: none;
    }
}
@media (max-width: 480px) {
    #directory p,ul {
        display: none;
    }
}
</style>
<div id="directory-content" class="directory-content">
    <div id="directory"></div>
</div>
<script type="text/javascript">
    $('#directory').html('<a id="openHiddenLinkId" href="javascript:void(0)" isopen="0" style="display:block;float:right;z-index: 2000;">↗</a><p style="margin: 0;text-align: center;padding-bottom: 5px;color: #08c;">目录</p>');
    var postDirectoryBuild = function() {
        $("#openHiddenLinkId").click(function(){
            var isopen = $(this).attr("isopen");
            if(isopen == "1"){
              $('#directory').find("p,ul").show(200);
              $(this).attr("isopen","0").html("↗");
            }else{
              $('#directory').find("p,ul").hide(200);
              $(this).attr("isopen","1").html("↙");
            }
        });
        var postChildren = function children(childNodes, reg) {
                var result = [],
                    isReg = typeof reg === 'object',
                    isStr = typeof reg === 'string',
                    node, i, len;
                for (i = 0, len = childNodes.length; i < len; i++) {
                    node = childNodes[i];
                    if ((node.nodeType === 1 || node.nodeType === 9) &&
                        (!reg ||
                        isReg && reg.test(node.tagName.toLowerCase()) ||
                        isStr && node.tagName.toLowerCase() === reg)) {
                        result.push(node);
                    }
                }
                return result;
            },
            createPostDirectory = function(article, directory, isDirNum) {
                var contentArr = [],
                    titleId = [],
                    levelArr, root, level,
                    currentList, list, li, link, i, len;
                levelArr = (function(article, contentArr, titleId) {
                    var titleElem = postChildren(article.childNodes, /^h\d$/),
                        levelArr = [],
                        lastNum = 1,
                        lastRevNum = 1,
                        count = 0,
                        guid = 1,
                        id = 'directory' + (Math.random() + '').replace(/\D/, ''),
                        lastRevNum, num, elem;
                    while (titleElem.length) {
                        elem = titleElem.shift();
                        contentArr.push(elem.innerHTML);
                        num = +elem.tagName.match(/\d/)[0];
                        if (num > lastNum) {
                            levelArr.push(1);
                            lastRevNum += 1;
                        } else if (num === lastRevNum ||
                            num > lastRevNum && num <= lastNum) {
                            levelArr.push(0);
                            lastRevNum = lastRevNum;
                        } else if (num < lastRevNum) {
                            levelArr.push(num - lastRevNum);
                            lastRevNum = num;
                        }
                        count += levelArr[levelArr.length - 1];
                        lastNum = num;
                        elem.id = elem.id || (id + guid++);
                        titleId.push(elem.id);
                    }
                    if (count !== 0 && levelArr[0] === 1) levelArr[0] = 0;

                    return levelArr;
                })(article, contentArr, titleId);
                currentList = root = document.createElement('ul');
                dirNum = [0];
                for (i = 0, len = levelArr.length; i < len; i++) {
                    level = levelArr[i];
                    if (level === 1) {
                        list = document.createElement('ul');
                        if (!currentList.lastElementChild) {
                            currentList.appendChild(document.createElement('li'));
                        }
                        currentList.lastElementChild.appendChild(list);
                        currentList = list;
                        dirNum.push(0);
                    } else if (level < 0) {
                        level *= 2;
                        while (level++) {
                            if (level % 2) dirNum.pop();
                            currentList = currentList.parentNode;
                        }
                    }
                    dirNum[dirNum.length - 1]++;
                    li = document.createElement('li');
                    link = document.createElement('a');
                    link.href = '#' + titleId[i];
                    link.innerHTML = !isDirNum ? contentArr[i] :
                        dirNum.join('.') + ' ' + contentArr[i] ;
                    li.appendChild(link);
                    currentList.appendChild(li);
                }
                directory.appendChild(root);
            };
        createPostDirectory(document.getElementById('articleBody'),document.getElementById('directory'), true);
    };
    postDirectoryBuild();
</script>




                    </div>
                </div>
            </div>
        </div>
        <footer class="the-footer">
    <div class="unit-foot">
        <div class="unit-inner unit-foot-inner">
            <div class="misc vcard">
                <div class="about">
                    <h4>
                        <a href="/blog/other/about/">关于</a>
                        
                    </h4>
                </div>
                <div class="social-links">
                    
                        <a class="ico-gmail" href="mailto:1460300366@qq.com" rel="me" target="_blank" title="email"></a>
                    
                    <a class="ico-rss" href="/feed.xml" rel="me" target="_blank" title="feed"></a>
                    
                        
                    
                        
                            <a class="ico-github" href="https://github.com/petterobam" rel="me" target="_blank" title="github"></a>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                </div>
            </div>
        </div>
    </div>
    <a href="#" class="internal back-to-top">返回顶部</a>
</footer>


    </div>

    <script>
$(document).ready(function () {
    var offset = 50,
        duration = 500,
        width = 960;
    var dirOldTop = 37;
    $(window).scroll(function () {
    	var scrollTop = $(this).scrollTop();
        if (scrollTop > width) {
            if (scrollTop > offset) {
                $('footer').css('top', '20px');
                $('footer .back-to-top').fadeIn(duration);
            } else {
                $('footer').css('top', 'auto');
                $('footer .back-to-top').fadeOut(duration);
            }
        }
        var directory = $("#directory");
        if(null != directory && directory.length > 0){
        	var top;
        	if(scrollTop > dirOldTop){
        		top = (scrollTop - dirOldTop) + "px";
        	}else{
        		top = dirOldTop + "px";
        	}
        	directory.css("top",top);
        }
    });
    $(window).resize(function () {
        if ($(window).width() < width) {
            $('footer').css('top', 'auto');
            $('footer .back-to-top').fadeOut(duration);
        }
        if ($(window).width() >= width && $(this).scrollTop() > offset) {
            $('footer').css('top', '20px');
            $('footer .back-to-top').fadeIn(duration);
        }
    });

    $('footer .back-to-top, .gotop').on('click', function (event) {
        event.preventDefault();
        $('html, body').animate({
            scrollTop: 0
        }, duration);
        return false;
    });

    $('.show-hidden').on('click', function () {
        $(this).parent().next().toggleClass("hidden");
        $(this).toggleClass("hidden");
    });
});
</script>

<!-- Google Analytics Event tracking -->


<!-- Show menu overlay + Jekyll Simple Search option -->
<script src="/assets/javascripts/jekyll-search.jquery.js"></script>
<script>
$(document).ready(function () {
    $('.search-field').simpleJekyllSearch({
      jsonFile: '/search.json',
      template: '<li><a href="{url}">{title} <span class="entry-date"><time datetime="{date}">{shortdate}</time></span></a></li>',
      searchResults: '.search-wrapper .results',
      searchResultsTitle: '<h4>搜索结果</h4>',
      noResults: '<p>啊哈<br/><small>什么也没找到 :(</small></p>'
    });
});

(function ($, window, undefined) {
    var closeOverlay = function () {
        $('.nav-wrapper, .search-wrapper').removeAttr('style');
        $(".nav-form, .search-form").removeClass('active');
        $("body").removeClass('nav-overlay search-overlay');
    };

    $('.nav-global .btn-init-live2dgirl').on('click', function () {
        initLive2dGirl();
    });

    $('.nav-global .btn-search').on('click', function () {
        $('.search-wrapper').css({display: "block"});
        $(".search-form").addClass('active');
        $(".search-form").find('input').focus();
        $("body").addClass('search-overlay');
    });

    $('.nav-global .btn-menu').on('click', function () {
        $('.nav-wrapper').css({display: "block"});
        $(".nav-form").addClass('active');
        $(".nav-form .search-field").prop('disabled', true);
        $("body").addClass('nav-overlay');
    });

    $('.nav-wrapper .btn-close, .search-wrapper .btn-close').on('click', function () {
        closeOverlay();
    });

    $(document).on('keyup', function (e) {
        if (e.keyCode === 27) {
            closeOverlay();
        }
    });
})(jQuery, window);
</script>

<script src='//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.js'></script>
<script src='//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-buttons.min.js'></script>
<script src="/assets/javascripts/unveil/jquery.unveil.min.js"></script>

<script>
    window.jQuery.fancybox || document.write('<script src="/assets/javascripts/fancybox/jquery.fancybox.pack.js?v=2.1.4"><\/script>')
    window.jQuery.fancybox.helpers.buttons || document.write('<script src="/assets/javascripts/fancybox/helpers/jquery.fancybox-buttons.js?v=1.0.5"><\/script>')
</script>

<script>
    $("head").append('<link rel="stylesheet" href="/assets/javascripts/fancybox/jquery.fancybox.css?v=2.1.4" type="text/css" />');
    $("head").append('<link rel="stylesheet" href="/assets/javascripts/fancybox/helpers/jquery.fancybox-buttons.css?v=1.0.5" type="text/css" />');
    $(".post-image").fancybox({
        prevEffect: 'none',
        nextEffect: 'none',
        closeBtn: true,
        helpers: {
            title: {
                type: 'float'
            }
        }
    });
    $(document).ready(function () {
        $(".post-image > img").unveil(450);
        $(".nav-global a[label='']").css("background-color", "orange")
    });
</script>

<!-- LaTeX 语法支持 -->
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

<!-- 动态隐藏 post 的 js -->
<style type="text/css">
  ul.post-list li.post2hide {
    display: none;
  }
</style>

<script text="text/javascript">
  $(document).ready(function() {
    // 获取URL参数
    const urlParams = new URLSearchParams(window.location.search);
    // 检查是否有action参数，并且其值为all
    if(urlParams.get('action') === 'all' || '' === 'all') {
      // 找到所有不可见的<li>元素并将其显示出来
      $('li.post2hide').show();
    }
  });
</script>
<!-- 折叠 post 列表 的 js -->


<!-- 图片点击预览 -->
<div id="imgEnlargeDiv" style="display: none; text-align: center;position: fixed;z-index: 1000;top: 0;left: 0;
    width: 100%;height: 100%;background-color: rgba(255,255,255,.9);overflow: hidden;">
    <img id="bigimg-random-12312" style="height: auto;width: 90%;
    position: absolute;margin:auto;top:0;bottom:0;left: 0;right: 0;" title="单击关闭图层" src="" />
</div>
<script type="text/javascript">
    // 图片放大  
    $(function () {
        $("#imgEnlargeDiv").click(function () {
            // 再次点击淡出消失弹出层    
            $(this).fadeOut("fast");
        });
        imgEnlarge();
    });

    function imgShow(outerdiv, bigimg, _this) {
        var src = _this.attr("src");// 获取当前点击的pimg元素中的src属性    
        $(bigimg).attr("src", src);// 设置#bigimg元素的src属性    
        $(outerdiv).fadeIn("fast");  // 图片放大的div快速淡入显示层
        var imgWidth = $(bigimg).width();
        var imgHeight = $(bigimg).height();
        if (imgHeight > imgWidth) {
            $(bigimg).css("height", "90%").css("width", "auto");
        } else {
            $(bigimg).css("height", "auto").css("width", "90%");
        }
    }

    var img2ShowExit = true;
    function imgEnlarge() {
        $(".entry-content img").mouseover(function () {
            $(this).css("cursor", "pointer");//鼠标移动到图片，鼠标箭头变为手势
        });
        $(".entry-content img").click(function () {
            var _this = $(this);// 将当前的pimg元素作为_this传入函数    
            imgShow("#imgEnlargeDiv", "#bigimg-random-12312", _this);
        });
    }
</script>
<!-- gist 引用折叠 -->
<script type="text/javascript">
$(function () {
    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        // 是移动设备
        $(".gist-file").click(function() {
            if ($(this).attr("pack-up") == "1") {
                $(this).find(".gist-data").css({
                    "overflow": "auto",
                    "height": "auto",
                    "border-bottom": "1px solid #ddd"
                });
                $(this).find(".gist-meta span").html('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ↑↑ 单击收起 ↑↑ &nbsp;&nbsp;&nbsp;');
                $(this).attr("pack-up", "0");
            } else {
                $(this).find(".gist-data").css({
                    "overflow": "hidden",
                    "height": "75px",
                    "border-bottom": "3px solid red"
                });
                $(this).find(".gist-meta span").html('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ↑↑ 单击展开 ↑↑ &nbsp;&nbsp;&nbsp;');
                $(this).attr("pack-up", "1");
            }
        });
      } else {
        $(".gist-file").dblclick(function() {
            if ($(this).attr("pack-up") == "1") {
                $(this).find(".gist-data").css({
                    "overflow": "auto",
                    "height": "auto",
                    "border-bottom": "1px solid #ddd"
                });
                $(this).find(".gist-meta span").html('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ↑↑ 双击收起 ↑↑ &nbsp;&nbsp;&nbsp;');
                $(this).attr("pack-up", "0");
            } else {
                $(this).find(".gist-data").css({
                    "overflow": "hidden",
                    "height": "75px",
                    "border-bottom": "3px solid red"
                });
                $(this).find(".gist-meta span").html('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ↑↑ 双击展开 ↑↑ &nbsp;&nbsp;&nbsp;');
                $(this).attr("pack-up", "1");
            }
        });
    }

    $(".gist-file").find(".gist-data").css({
        "overflow": "hidden",
        "height": "75px",
        "border-bottom": "3px solid red"
    });
    $(".gist-file").attr("pack-up", "1");
    $(".gist-file").find(".gist-data").css({"cursor":"pointer"});
    $(".gist-file").find(".gist-meta").append('<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ↑↑ 双击展开 ↑↑</span>');
});
</script>


<!-- live2dgirl加载 -->

<link rel="stylesheet" type="text/css" href="/assets/javascripts/live2dgirl/waifu.css"/>
<!-- <script src="/assets/javascripts/live2dgirl/jquery.min.js"></script> -->
<div class="waifu">
    <div class="waifu-tips"></div>
    <canvas id="live2d" width="280" height="250" class="live2d"></canvas>
    <div class="waifu-tool">
        <span class="fui-home"></span>
        <span class="fui-chat"></span>
        <span class="fui-eye"></span>
        <span class="fui-user"></span>
        <span class="fui-photo"></span>
        <span class="fui-info-circle"></span>
        <span class="fui-cross"></span>
    </div>
</div>
<script sync src="/assets/javascripts/live2dgirl/waifu-tips.js"></script>
<script sync src="/assets/javascripts/live2dgirl/live2d.js"></script>
<script type="text/javascript">
function initLive2dGirl() {
    $(".waifu").css('display', 'block');
    initModel("/assets/javascripts/live2dgirl/");
}
</script>


</body>

</html>